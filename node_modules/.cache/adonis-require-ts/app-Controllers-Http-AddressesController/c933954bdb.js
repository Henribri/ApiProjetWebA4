"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const jsonwebtoken_1 = __importDefault(require("jsonwebtoken"));
const Address_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/Address"));
const User_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/User"));
const Restorer_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/Restorer"));
class AddressesController {
    async index({ response, request }) {
        try {
            const user_id = this.getId(request);
            if (user_id) {
                const user = await User_1.default.findOrFail(user_id);
                if (user.role.role_id == 5 || user.role.role_id == 4) {
                    const addresses = await Address_1.default.query();
                    return response.status(200).json(addresses);
                }
                else {
                    return response.status(403).json({ message: "Error you don't have the correct permissions" });
                }
            }
            else {
                return response.status(500).json({ err: "jwt token error" });
            }
        }
        catch (err) {
            return response.status(500).json({ err });
        }
    }
    async getById({ params, response, request }) {
        try {
            const user_id = this.getId(request);
            if (user_id) {
                const user = await User_1.default.findOrFail(user_id);
                if (params.type == 'payment' && user.fk_payment_address_id != null) {
                    const address = await Address_1.default.findOrFail(user.fk_payment_address_id);
                    console.log('test');
                    return response.status(200).json(address);
                }
                else if (params.type == 'payment' && user.fk_payment_address_id == null) {
                    return response.status(400).json({ message: 'This user does not have a payment address yet create it instead' });
                }
                if (params.type == 'delivery' && user.fk_delivery_address_id != null) {
                    const address = await Address_1.default.findOrFail(user.fk_payment_address_id);
                    return response.status(200).json(address);
                }
                else if (params.type == 'delivery' && user.fk_delivery_address_id == null) {
                    return response.status(400).json({ message: 'This user does not have a payment address yet create it instead' });
                }
                if (params.type == 'restorer' && user.fk_restorer_id != null) {
                    const restorer = await Restorer_1.default.findOrFail(user.fk_restorer_id);
                    const address = await Address_1.default.findOrFail(restorer.fk_address_id);
                    return response.status(200).json(address);
                }
                else if (params.type == 'restorer' && user.fk_restorer_id == null) {
                    return response.status(400).json({ message: 'This user does not have a restorer yet create it instead' });
                }
                if (!user) {
                    return response.status(403).json({ message: 'error wrong user id' });
                }
                else {
                    return response.status(403).json({ message: 'error wrong user id' });
                }
            }
            else {
                return response.status(500).json({ err: "jwt token error" });
            }
        }
        catch (err) {
            return response.status(404).json('not found');
        }
    }
    async create({ request, response, params }) {
        try {
            const user_id = this.getId(request);
            if (user_id) {
                const user = await User_1.default.findOrFail(user_id);
                if (params.type == 'payment' && user.fk_payment_address_id == null) {
                    const address = await Address_1.default.create({ address_city: request.body()['address_city'], address_street: request.body()['address_street'], address_street_number: request.body()['address_street_number'], address_postal_code: request.body()['address_postal_code'] });
                    await user.related('payment_address_id').associate(address);
                    return response.status(201).json({ address });
                }
                else if (user.fk_payment_address_id != null) {
                    return response.status(400).json({ message: 'This user has already a payment address update it instead' });
                }
                if (params.type == 'delivery' && user.fk_delivery_address_id == null) {
                    const address = await Address_1.default.create({ address_city: request.body()['address_city'], address_street: request.body()['address_street'], address_street_number: request.body()['address_street_number'], address_postal_code: request.body()['address_postal_code'] });
                    await user.related('delivery_address_id').associate(address);
                    return response.status(201).json({ address });
                }
                else if (user.fk_delivery_address_id != null) {
                    return response.status(400).json({ message: 'This user has already a delivery address update it instead' });
                }
                else {
                    return response.status(500).json({ message: 'error wrong user id or params' });
                }
            }
            else {
                return response.status(500).json({ err: "jwt token error" });
            }
        }
        catch (err) {
            return response.status(500).json({ err });
        }
    }
    async update({ request, response, params }) {
        try {
            const user_id = this.getId(request);
            if (user_id) {
                const user = await User_1.default.findOrFail(user_id);
                if (params.type == 'payment' && user.fk_payment_address_id != null) {
                    const address = await Address_1.default.findOrFail(user.fk_payment_address_id);
                    address.merge(request.body());
                    await address.save();
                    return response.status(200).json({ address });
                }
                else if (params.type == 'payment' && user.fk_payment_address_id == null) {
                    return response.status(400).json({ message: 'This user does not have a payment address yet create it instead' });
                }
                if (params.type == 'delivery' && user.fk_delivery_address_id != null) {
                    const address = await Address_1.default.findOrFail(user.fk_payment_address_id);
                    address.merge(request.body());
                    await address.save();
                    return response.status(200).json({ address });
                }
                else if (params.type == 'delivery' && user.fk_delivery_address_id == null) {
                    return response.status(400).json({ message: 'This user does not have a payment address yet create it instead' });
                }
                if (params.type == 'restorer' && user.fk_restorer_id != null) {
                    const restorer = await Restorer_1.default.findOrFail(user.fk_restorer_id);
                    const address = await Address_1.default.findOrFail(restorer.fk_address_id);
                    address.merge(request.body());
                    await address.save();
                    return response.status(200).json({ address });
                }
                else if (params.type == 'restorer' && user.fk_restorer_id == null) {
                    return response.status(400).json({ message: 'This user does not have a restorer yet create it instead' });
                }
                else {
                    return response.status(403).json({ message: 'Error wrong user id' });
                }
            }
            else {
                return response.status(500).json({ err: "jwt token error" });
            }
        }
        catch (err) {
            return response.status(500).json({ err });
        }
    }
    async delete({ response, request, params }) {
        try {
            const user_id = this.getId(request);
            if (user_id) {
                const user = await User_1.default.findOrFail(user_id);
                if (params.type == 'payment' && user.fk_payment_address_id != null) {
                    const address = await Address_1.default.findOrFail(user.fk_payment_address_id);
                    await address.delete();
                    return response.status(200).json({ address });
                }
                else if (params.type == 'payment' && user.fk_payment_address_id == null) {
                    return response.status(400).json({ message: 'This user does not have a payment address yet' });
                }
                if (params.type == 'delivery' && user.fk_delivery_address_id != null) {
                    const address = await Address_1.default.findOrFail(user.fk_payment_address_id);
                    await address.delete();
                    return response.status(200).json({ address });
                }
                else if (params.type == 'delivery' && user.fk_delivery_address_id == null) {
                    return response.status(400).json({ message: 'This user does not have a payment address yet' });
                }
                if (params.type == 'restorer' && user.fk_restorer_id != null) {
                    const restorer = await Restorer_1.default.findOrFail(user.fk_restorer_id);
                    const address = await Address_1.default.findOrFail(restorer.fk_address_id);
                    await address.delete();
                    return response.status(200).json({ address });
                }
                else if (params.type == 'restorer' && user.fk_restorer_id == null) {
                    return response.status(400).json({ message: 'This user does not have a restorer yet' });
                }
                else {
                    return response.status(403).json({ message: 'Error wrong user id' });
                }
            }
            else {
                return response.status(500).json({ err: "jwt token error" });
            }
        }
        catch (err) {
            return response.status(500).json({ err });
        }
    }
    getId(request) {
        const token = request.header('authorization')?.split(" ");
        try {
            const user_id = jsonwebtoken_1.default.verify(token[1], 'TOKEN_PRIVATE_KEY')['user_id'];
            return user_id;
        }
        catch {
            return false;
        }
    }
}
exports.default = AddressesController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQWRkcmVzc2VzQ29udHJvbGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkFkZHJlc3Nlc0NvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFDQSxnRUFBOEI7QUFFOUIsdUZBQXlDO0FBQ3pDLGlGQUFtQztBQUNuQyx5RkFBMkM7QUFFM0MsTUFBcUIsbUJBQW1CO0lBVzdCLEtBQUssQ0FBQyxLQUFLLENBQUUsRUFBQyxRQUFRLEVBQUMsT0FBTyxFQUFxQjtRQUN0RCxJQUFHO1lBQ0MsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQTtZQUNuQyxJQUFJLE9BQU8sRUFBQztnQkFDUixNQUFNLElBQUksR0FBRyxNQUFNLGNBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUE7Z0JBQzNDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxJQUFJLENBQUMsRUFBQztvQkFDakQsTUFBTSxTQUFTLEdBQUcsTUFBTSxpQkFBTyxDQUFDLEtBQUssRUFBRSxDQUFBO29CQUN2QyxPQUFPLFFBQVEsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFBO2lCQUM5QztxQkFBSTtvQkFDRCxPQUFPLFFBQVEsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUMsT0FBTyxFQUFFLDhDQUE4QyxFQUFDLENBQUMsQ0FBQTtpQkFDOUY7YUFDSjtpQkFBSTtnQkFDRCxPQUFPLFFBQVEsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUMsR0FBRyxFQUFDLGlCQUFpQixFQUFDLENBQUMsQ0FBQTthQUM1RDtTQUdKO1FBQUEsT0FBTSxHQUFHLEVBQUM7WUFDUCxPQUFPLFFBQVEsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFD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QUFHLHNCQUFHLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxtQkFBbUIsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFBO1lBQ3BFLE9BQU8sT0FBTyxDQUFBO1NBQ2pCO1FBQUEsTUFBSztZQUNGLE9BQU8sS0FBSyxDQUFBO1NBQ2Y7SUFFTCxDQUFDO0NBQ0o7QUFsT0Qsc0NBa09DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSHR0cENvbnRleHRDb250cmFjdCB9IGZyb20gJ0Bpb2M6QWRvbmlzL0NvcmUvSHR0cENvbnRleHQnXG5pbXBvcnQgand0IGZyb20gJ2pzb253ZWJ0b2tlbidcblxuaW1wb3J0IEFkZHJlc3MgZnJvbSBcIkFwcC9Nb2RlbHMvQWRkcmVzc1wiO1xuaW1wb3J0IFVzZXIgZnJvbSAnQXBwL01vZGVscy9Vc2VyJztcbmltcG9ydCBSZXN0b3JlciBmcm9tICdBcHAvTW9kZWxzL1Jlc3RvcmVyJztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQWRkcmVzc2VzQ29udHJvbGxlciB7XG5cblxuICAgIC8qKlxuICAgICAqIEBhcGkge2dldH0gL2FkZHJlc3NlcyBSZXF1ZXN0IGFsbCBhZGRyZXNzZXNcbiAgICAgKiBAYXBpTmFtZSBpbmRleFxuICAgICAqIEBhcGlHcm91cCBBZGRyZXNzXG4gICAgICogQGFwaVN1Y2Nlc3Mge09iamVjdH0gYWRkcmVzcyBvYmplY3RzLlxuICAgICAqIEBhcGlFcnJvciAoNTAwKSBFcnJvciBFcnJvciB0byByZXF1ZXN0IGRhdGFiYXNlLlxuICAgICAqIEBhcGlFcnJvciAoNDAzKSBFcnJvciB5b3UgZG9uJ3QgaGF2ZSBwZXJtaXNzaW9uLlxuICAgICAqL1xuICAgIHB1YmxpYyBhc3luYyBpbmRleCAoe3Jlc3BvbnNlLHJlcXVlc3R9Okh0dHBDb250ZXh0Q29udHJhY3Qpe1xuICAgICAgICB0cnl7XG4gICAgICAgICAgICBjb25zdCB1c2VyX2lkID0gdGhpcy5nZXRJZChyZXF1ZXN0KVxuICAgICAgICAgICAgaWYgKHVzZXJfaWQpe1xuICAgICAgICAgICAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyLmZpbmRPckZhaWwodXNlcl9pZClcbiAgICAgICAgICAgICAgICBpZiAodXNlci5yb2xlLnJvbGVfaWQgPT0gNSB8fCB1c2VyLnJvbGUucm9sZV9pZCA9PSA0KXtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWRkcmVzc2VzID0gYXdhaXQgQWRkcmVzcy5xdWVyeSgpXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoMjAwKS5qc29uKGFkZHJlc3NlcylcbiAgICAgICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg0MDMpLmpzb24oe21lc3NhZ2U6IFwiRXJyb3IgeW91IGRvbid0IGhhdmUgdGhlIGNvcnJlY3QgcGVybWlzc2lvbnNcIn0pXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg1MDApLmpzb24oe2VycjpcImp3dCB0b2tlbiBlcnJvclwifSlcbiAgICAgICAgICAgIH1cblxuXG4gICAgICAgIH1jYXRjaChlcnIpe1xuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg1MDApLmpzb24oe2Vycn0pXG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBhcGkge2dldH0gL2FkZHJlc3NlcyBSZXF1ZXN0IGFsbCBhZGRyZXNzZXNcbiAgICAgKiBAYXBpTmFtZSBpbmRleFxuICAgICAqIEBhcGlHcm91cCBBZGRyZXNzXG4gICAgICogQGFwaVN1Y2Nlc3Mge09iamVjdH0gYWRkcmVzcyBvYmplY3RzLlxuICAgICAqIEBhcGlFcnJvciAoNTAwKSBFcnJvciBFcnJvciB0byByZXF1ZXN0IGRhdGFiYXNlLlxuICAgICAqIEBhcGlFcnJvciAoNDAzKSBFcnJvciB5b3UgZG9uJ3QgaGF2ZSBwZXJtaXNzaW9uLlxuICAgICAqL1xuICAgIHB1YmxpYyBhc3luYyBnZXRCeUlkICh7cGFyYW1zLHJlc3BvbnNlLHJlcXVlc3R9Okh0dHBDb250ZXh0Q29udHJhY3Qpe1xuICAgICAgICB0cnl7XG4gICAgICAgICAgICBjb25zdCB1c2VyX2lkID0gdGhpcy5nZXRJZChyZXF1ZXN0KVxuXG4gICAgICAgICAgICBpZiAodXNlcl9pZCl7XG4gICAgICAgICAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZE9yRmFpbCh1c2VyX2lkKVxuXG4gICAgICAgICAgICAgICAgaWYgKHBhcmFtcy50eXBlPT0ncGF5bWVudCcgJiYgdXNlci5ma19wYXltZW50X2FkZHJlc3NfaWQhPW51bGwpe1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBhZGRyZXNzID0gYXdhaXQgQWRkcmVzcy5maW5kT3JGYWlsKHVzZXIuZmtfcGF5bWVudF9hZGRyZXNzX2lkKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ3Rlc3QnKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDIwMCkuanNvbihhZGRyZXNzKVxuICAgICAgICAgICAgICAgIH1lbHNlIGlmKHBhcmFtcy50eXBlPT0ncGF5bWVudCcgJiYgdXNlci5ma19wYXltZW50X2FkZHJlc3NfaWQ9PW51bGwpe1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDQwMCkuanNvbih7bWVzc2FnZSA6ICdUaGlzIHVzZXIgZG9lcyBub3QgaGF2ZSBhIHBheW1lbnQgYWRkcmVzcyB5ZXQgY3JlYXRlIGl0IGluc3RlYWQnfSlcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZihwYXJhbXMudHlwZT09J2RlbGl2ZXJ5JyAmJiB1c2VyLmZrX2RlbGl2ZXJ5X2FkZHJlc3NfaWQhPW51bGwpe1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBhZGRyZXNzID0gYXdhaXQgQWRkcmVzcy5maW5kT3JGYWlsKHVzZXIuZmtfcGF5bWVudF9hZGRyZXNzX2lkKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cygyMDApLmpzb24oYWRkcmVzcylcbiAgICAgICAgICAgICAgICB9ZWxzZSBpZihwYXJhbXMudHlwZT09J2RlbGl2ZXJ5JyAmJiB1c2VyLmZrX2RlbGl2ZXJ5X2FkZHJlc3NfaWQ9PW51bGwpe1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDQwMCkuanNvbih7bWVzc2FnZSA6ICdUaGlzIHVzZXIgZG9lcyBub3QgaGF2ZSBhIHBheW1lbnQgYWRkcmVzcyB5ZXQgY3JlYXRlIGl0IGluc3RlYWQnfSlcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZihwYXJhbXMudHlwZT09J3Jlc3RvcmVyJyAmJiB1c2VyLmZrX3Jlc3RvcmVyX2lkIT1udWxsKXtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzdG9yZXIgPSBhd2FpdCBSZXN0b3Jlci5maW5kT3JGYWlsKHVzZXIuZmtfcmVzdG9yZXJfaWQpXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGFkZHJlc3MgPSBhd2FpdCBBZGRyZXNzLmZpbmRPckZhaWwocmVzdG9yZXIuZmtfYWRkcmVzc19pZCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoMjAwKS5qc29uKGFkZHJlc3MpXG4gICAgICAgICAgICAgICAgfWVsc2UgaWYocGFyYW1zLnR5cGU9PSdyZXN0b3JlcicgJiYgIHVzZXIuZmtfcmVzdG9yZXJfaWQ9PW51bGwpe1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDQwMCkuanNvbih7bWVzc2FnZSA6ICdUaGlzIHVzZXIgZG9lcyBub3QgaGF2ZSBhIHJlc3RvcmVyIHlldCBjcmVhdGUgaXQgaW5zdGVhZCd9KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZighdXNlcil7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNDAzKS5qc29uKHttZXNzYWdlOidlcnJvciB3cm9uZyB1c2VyIGlkJ30pXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2V7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNDAzKS5qc29uKHttZXNzYWdlOidlcnJvciB3cm9uZyB1c2VyIGlkJ30pXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg1MDApLmpzb24oe2VycjpcImp3dCB0b2tlbiBlcnJvclwifSlcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9Y2F0Y2goZXJyKXtcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNDA0KS5qc29uKCdub3QgZm91bmQnKVxuICAgICAgICB9XG5cbiAgICB9XG5cblxuICAgIHB1YmxpYyBhc3luYyBjcmVhdGUoeyByZXF1ZXN0ICwgcmVzcG9uc2UscGFyYW1zIH06SHR0cENvbnRleHRDb250cmFjdCl7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHVzZXJfaWQgPSB0aGlzLmdldElkKHJlcXVlc3QpXG4gICAgICAgICAgICBpZiAodXNlcl9pZCl7XG4gICAgICAgICAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZE9yRmFpbCh1c2VyX2lkKVxuICAgICAgICAgICAgICAgIGlmIChwYXJhbXMudHlwZT09J3BheW1lbnQnICYmIHVzZXIuZmtfcGF5bWVudF9hZGRyZXNzX2lkPT1udWxsKXtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWRkcmVzcyA9IGF3YWl0IEFkZHJlc3MuY3JlYXRlKHthZGRyZXNzX2NpdHk6IHJlcXVlc3QuYm9keSgpWydhZGRyZXNzX2NpdHknXSwgYWRkcmVzc19zdHJlZXQ6IHJlcXVlc3QuYm9keSgpWydhZGRyZXNzX3N0cmVldCddLCBhZGRyZXNzX3N0cmVldF9udW1iZXI6IHJlcXVlc3QuYm9keSgpWydhZGRyZXNzX3N0cmVldF9udW1iZXInXSwgYWRkcmVzc19wb3N0YWxfY29kZTpyZXF1ZXN0LmJvZHkoKVsnYWRkcmVzc19wb3N0YWxfY29kZSddIH0pO1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCB1c2VyLnJlbGF0ZWQoJ3BheW1lbnRfYWRkcmVzc19pZCcpLmFzc29jaWF0ZShhZGRyZXNzKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDIwMSkuanNvbih7YWRkcmVzc30pXG4gICAgICAgICAgICAgICAgfWVsc2UgaWYodXNlci5ma19wYXltZW50X2FkZHJlc3NfaWQhPW51bGwpe1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDQwMCkuanNvbih7bWVzc2FnZSA6ICdUaGlzIHVzZXIgaGFzIGFscmVhZHkgYSBwYXltZW50IGFkZHJlc3MgdXBkYXRlIGl0IGluc3RlYWQnfSlcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZihwYXJhbXMudHlwZT09J2RlbGl2ZXJ5JyAmJiB1c2VyLmZrX2RlbGl2ZXJ5X2FkZHJlc3NfaWQ9PW51bGwpe1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBhZGRyZXNzID0gYXdhaXQgQWRkcmVzcy5jcmVhdGUoe2FkZHJlc3NfY2l0eTogcmVxdWVzdC5ib2R5KClbJ2FkZHJlc3NfY2l0eSddLCBhZGRyZXNzX3N0cmVldDogcmVxdWVzdC5ib2R5KClbJ2FkZHJlc3Nfc3RyZWV0J10sIGFkZHJlc3Nfc3RyZWV0X251bWJlcjogcmVxdWVzdC5ib2R5KClbJ2FkZHJlc3Nfc3RyZWV0X251bWJlciddLCBhZGRyZXNzX3Bvc3RhbF9jb2RlOnJlcXVlc3QuYm9keSgpWydhZGRyZXNzX3Bvc3RhbF9jb2RlJ10gfSk7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHVzZXIucmVsYXRlZCgnZGVsaXZlcnlfYWRkcmVzc19pZCcpLmFzc29jaWF0ZShhZGRyZXNzKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDIwMSkuanNvbih7YWRkcmVzc30pXG4gICAgICAgICAgICAgICAgfWVsc2UgaWYodXNlci5ma19kZWxpdmVyeV9hZGRyZXNzX2lkIT1udWxsKXtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg0MDApLmpzb24oe21lc3NhZ2UgOiAnVGhpcyB1c2VyIGhhcyBhbHJlYWR5IGEgZGVsaXZlcnkgYWRkcmVzcyB1cGRhdGUgaXQgaW5zdGVhZCd9KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNle1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDUwMCkuanNvbih7bWVzc2FnZTonZXJyb3Igd3JvbmcgdXNlciBpZCBvciBwYXJhbXMnfSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDUwMCkuanNvbih7ZXJyOlwiand0IHRva2VuIGVycm9yXCJ9KVxuICAgICAgICAgICAgfVxuXG5cblxuICAgICAgICB9IGNhdGNoKGVycil7XG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDUwMCkuanNvbih7ZXJyfSlcbiAgICAgICAgfVxuXG4gICAgfVxuXG5cbiAgICBwdWJsaWMgYXN5bmMgdXBkYXRlKHtyZXF1ZXN0LCByZXNwb25zZSwgcGFyYW1zfTpIdHRwQ29udGV4dENvbnRyYWN0KXtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHVzZXJfaWQgPSB0aGlzLmdldElkKHJlcXVlc3QpXG5cbiAgICAgICAgICAgIGlmICh1c2VyX2lkKXtcbiAgICAgICAgICAgICAgICBjb25zdCB1c2VyID0gYXdhaXQgVXNlci5maW5kT3JGYWlsKHVzZXJfaWQpXG4gICAgICAgICAgICAgICAgaWYgKHBhcmFtcy50eXBlPT0ncGF5bWVudCcgJiYgdXNlci5ma19wYXltZW50X2FkZHJlc3NfaWQhPW51bGwpe1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBhZGRyZXNzID0gYXdhaXQgQWRkcmVzcy5maW5kT3JGYWlsKHVzZXIuZmtfcGF5bWVudF9hZGRyZXNzX2lkKTtcbiAgICAgICAgICAgICAgICAgICAgYWRkcmVzcy5tZXJnZShyZXF1ZXN0LmJvZHkoKSk7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IGFkZHJlc3Muc2F2ZSgpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDIwMCkuanNvbih7YWRkcmVzc30pXG4gICAgICAgICAgICAgICAgfWVsc2UgaWYocGFyYW1zLnR5cGU9PSdwYXltZW50JyAmJiB1c2VyLmZrX3BheW1lbnRfYWRkcmVzc19pZD09bnVsbCl7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNDAwKS5qc29uKHttZXNzYWdlIDogJ1RoaXMgdXNlciBkb2VzIG5vdCBoYXZlIGEgcGF5bWVudCBhZGRyZXNzIHlldCBjcmVhdGUgaXQgaW5zdGVhZCd9KVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmKHBhcmFtcy50eXBlPT0nZGVsaXZlcnknICYmIHVzZXIuZmtfZGVsaXZlcnlfYWRkcmVzc19pZCE9bnVsbCl7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGFkZHJlc3MgPSBhd2FpdCBBZGRyZXNzLmZpbmRPckZhaWwodXNlci5ma19wYXltZW50X2FkZHJlc3NfaWQpO1xuICAgICAgICAgICAgICAgICAgICBhZGRyZXNzLm1lcmdlKHJlcXVlc3QuYm9keSgpKTtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgYWRkcmVzcy5zYXZlKCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoMjAwKS5qc29uKHthZGRyZXNzfSlcbiAgICAgICAgICAgICAgICB9ZWxzZSBpZihwYXJhbXMudHlwZT09J2RlbGl2ZXJ5JyAmJiB1c2VyLmZrX2RlbGl2ZXJ5X2FkZHJlc3NfaWQ9PW51bGwpe1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDQwMCkuanNvbih7bWVzc2FnZSA6ICdUaGlzIHVzZXIgZG9lcyBub3QgaGF2ZSBhIHBheW1lbnQgYWRkcmVzcyB5ZXQgY3JlYXRlIGl0IGluc3RlYWQnfSlcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZihwYXJhbXMudHlwZT09J3Jlc3RvcmVyJyAmJiB1c2VyLmZrX3Jlc3RvcmVyX2lkIT1udWxsKXtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzdG9yZXIgPSBhd2FpdCBSZXN0b3Jlci5maW5kT3JGYWlsKHVzZXIuZmtfcmVzdG9yZXJfaWQpXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGFkZHJlc3MgPSBhd2FpdCBBZGRyZXNzLmZpbmRPckZhaWwocmVzdG9yZXIuZmtfYWRkcmVzc19pZCk7XG4gICAgICAgICAgICAgICAgICAgIGFkZHJlc3MubWVyZ2UocmVxdWVzdC5ib2R5KCkpO1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCBhZGRyZXNzLnNhdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cygyMDApLmpzb24oe2FkZHJlc3N9KVxuICAgICAgICAgICAgICAgIH1lbHNlIGlmKHBhcmFtcy50eXBlPT0ncmVzdG9yZXInICYmIHVzZXIuZmtfcmVzdG9yZXJfaWQ9PW51bGwpe1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDQwMCkuanNvbih7bWVzc2FnZSA6ICdUaGlzIHVzZXIgZG9lcyBub3QgaGF2ZSBhIHJlc3RvcmVyIHlldCBjcmVhdGUgaXQgaW5zdGVhZCd9KVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGVsc2V7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNDAzKS5qc29uKHttZXNzYWdlOidFcnJvciB3cm9uZyB1c2VyIGlkJ30pXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg1MDApLmpzb24oe2VycjpcImp3dCB0b2tlbiBlcnJvclwifSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgfWNhdGNoKGVycil7XG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDUwMCkuanNvbih7ZXJyfSlcbiAgICAgICAgfVxuXG4gICAgfVxuXG5cblxuICAgIHB1YmxpYyBhc3luYyBkZWxldGUoe3Jlc3BvbnNlLHJlcXVlc3QsIHBhcmFtc306SHR0cENvbnRleHRDb250cmFjdCl7XG4gICAgICAgIHRyeXtcbiAgICAgICAgICAgIGNvbnN0IHVzZXJfaWQgPSB0aGlzLmdldElkKHJlcXVlc3QpXG4gICAgICAgICAgICBpZiAodXNlcl9pZCl7XG4gICAgICAgICAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZE9yRmFpbCh1c2VyX2lkKVxuICAgICAgICAgICAgICAgIGlmIChwYXJhbXMudHlwZT09J3BheW1lbnQnICYmIHVzZXIuZmtfcGF5bWVudF9hZGRyZXNzX2lkIT1udWxsKXtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWRkcmVzcyA9IGF3YWl0IEFkZHJlc3MuZmluZE9yRmFpbCh1c2VyLmZrX3BheW1lbnRfYWRkcmVzc19pZCk7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IGFkZHJlc3MuZGVsZXRlKCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoMjAwKS5qc29uKHthZGRyZXNzfSlcbiAgICAgICAgICAgICAgICB9ZWxzZSBpZihwYXJhbXMudHlwZT09J3BheW1lbnQnICYmIHVzZXIuZmtfcGF5bWVudF9hZGRyZXNzX2lkPT1udWxsKXtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg0MDApLmpzb24oe21lc3NhZ2UgOiAnVGhpcyB1c2VyIGRvZXMgbm90IGhhdmUgYSBwYXltZW50IGFkZHJlc3MgeWV0J30pXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYocGFyYW1zLnR5cGU9PSdkZWxpdmVyeScgJiYgdXNlci5ma19kZWxpdmVyeV9hZGRyZXNzX2lkIT1udWxsKXtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWRkcmVzcyA9IGF3YWl0IEFkZHJlc3MuZmluZE9yRmFpbCh1c2VyLmZrX3BheW1lbnRfYWRkcmVzc19pZCk7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IGFkZHJlc3MuZGVsZXRlKCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoMjAwKS5qc29uKHthZGRyZXNzfSlcbiAgICAgICAgICAgICAgICB9ZWxzZSBpZihwYXJhbXMudHlwZT09J2RlbGl2ZXJ5JyAmJnVzZXIuZmtfZGVsaXZlcnlfYWRkcmVzc19pZD09bnVsbCl7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNDAwKS5qc29uKHttZXNzYWdlIDogJ1RoaXMgdXNlciBkb2VzIG5vdCBoYXZlIGEgcGF5bWVudCBhZGRyZXNzIHlldCd9KVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmKHBhcmFtcy50eXBlPT0ncmVzdG9yZXInICYmIHVzZXIuZmtfcmVzdG9yZXJfaWQhPW51bGwpe1xuICAgICAgICAgICAgICAgICAgICBjb25zdCByZXN0b3JlciA9IGF3YWl0IFJlc3RvcmVyLmZpbmRPckZhaWwodXNlci5ma19yZXN0b3Jlcl9pZClcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWRkcmVzcyA9IGF3YWl0IEFkZHJlc3MuZmluZE9yRmFpbChyZXN0b3Jlci5ma19hZGRyZXNzX2lkKTtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgYWRkcmVzcy5kZWxldGUoKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cygyMDApLmpzb24oe2FkZHJlc3N9KVxuICAgICAgICAgICAgICAgIH1lbHNlIGlmKHBhcmFtcy50eXBlPT0ncmVzdG9yZXInICYmIHVzZXIuZmtfcmVzdG9yZXJfaWQ9PW51bGwpe1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDQwMCkuanNvbih7bWVzc2FnZSA6ICdUaGlzIHVzZXIgZG9lcyBub3QgaGF2ZSBhIHJlc3RvcmVyIHlldCd9KVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGVsc2V7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNDAzKS5qc29uKHttZXNzYWdlOidFcnJvciB3cm9uZyB1c2VyIGlkJ30pXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg1MDApLmpzb24oe2VycjpcImp3dCB0b2tlbiBlcnJvclwifSlcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9Y2F0Y2goZXJyKXtcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNTAwKS5qc29uKHtlcnJ9KVxuICAgICAgICB9XG5cblxuICAgIH1cblxuICAgIHB1YmxpYyAgZ2V0SWQocmVxdWVzdCl7XG4gICAgICAgIGNvbnN0IHRva2VuID0gIHJlcXVlc3QuaGVhZGVyKCdhdXRob3JpemF0aW9uJyk/LnNwbGl0KFwiIFwiKVxuICAgICAgICB0cnl7XG4gICAgICAgICAgICBjb25zdCB1c2VyX2lkID0gand0LnZlcmlmeSh0b2tlblsxXSwgJ1RPS0VOX1BSSVZBVEVfS0VZJylbJ3VzZXJfaWQnXVxuICAgICAgICAgICAgcmV0dXJuIHVzZXJfaWRcbiAgICAgICAgfWNhdGNoe1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICAgIH1cblxuICAgIH1cbn1cbiJdfQ==