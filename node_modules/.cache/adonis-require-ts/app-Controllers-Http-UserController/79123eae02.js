"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const User_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/User"));
const CreditCard_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/CreditCard"));
const Address_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/Address"));
const Role_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/Role"));
const Restorer_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/Restorer"));
const jsonwebtoken_1 = __importDefault(require("jsonwebtoken"));
class UsersController {
    async index({ response, request }) {
        try {
            const user = await User_1.default.findOrFail(jsonwebtoken_1.default.verify(request.input('jwt'), 'TOKEN_PRIVATE_KEY')['user_id']);
            if (user.role.role_id == 5 || user.role.role_id == 4) {
                const users = await User_1.default.query()
                    .preload('role')
                    .preload('credit_card')
                    .preload('delivery_address_id')
                    .preload('payment_address_id')
                    .preload('restorer');
                return response.status(200).json({ users });
            }
            else {
                return response.status(403).json({ message: "Error you don't have the correct permissions" });
            }
        }
        catch (err) {
            return response.status(500).json({ err });
        }
    }
    async getById({ params, response, request }) {
        try {
            const user = await User_1.default.findOrFail(jsonwebtoken_1.default.verify(request.input('jwt'), 'TOKEN_PRIVATE_KEY')['user_id']);
            return response.status(200).json({ user });
        }
        catch (err) {
            return response.status(500).json({ err });
        }
    }
    async createClient({ request, response }) {
        try {
            const existing_user = await User_1.default.findBy('user_email', request.body()['user_email']);
            if (!existing_user) {
                const user = await User_1.default.create({ user_firstname: request.body()['user_firstname'], user_lastname: request.body()['user_lastname'], user_email: request.body()['user_email'], password: request.body()['user_password'], user_phone_number: request.body()['user_phone_number'], user_is_supported: false, user_support: false, user_is_delivery: false });
                if (request.body()['delivery_address_city'] != undefined && request.body()['delivery_address_street'] != undefined && request.body()['delivery_address_postal_code'] != undefined && request.body()['delivery_address_street_number'] != undefined) {
                    const delivery_address = await Address_1.default.create({ address_city: request.body()['delivery_address_city'], address_street: request.body()['delivery_address_street'], address_street_number: request.body()['delivery_address_street_number'], address_postal_code: request.body()['delivery_address_postal_code'] });
                    await user.related('delivery_address_id').associate(delivery_address);
                }
                if (request.body()['payment_address_city'] != undefined && request.body()['payment_address_street'] != undefined && request.body()['payment_address_postal_code'] != undefined && request.body()['payment_address_street_number'] != undefined) {
                    const payment_address = await Address_1.default.create({ address_city: request.body()['payment_address_city'], address_street: request.body()['payment_address_street'], address_street_number: request.body()['payment_address_street_number'], address_postal_code: request.body()['payment_address_postal_code'] });
                    await user.related('payment_address_id').associate(payment_address);
                }
                if (request.body()['credit_card_type'] != undefined && request.body()['credit_card_num'] != undefined) {
                    const creditcard = await CreditCard_1.default.create({ credit_card_type: request.body()['credit_card_type'], credit_card_num: request.body()['credit_card_num'] });
                    await user.related('credit_card').associate(creditcard);
                }
                const role = await Role_1.default.findOrFail(1);
                await user.related('role').associate(role);
                return response.status(201).json({ user });
            }
            else {
                return response.status(400).json({ message: "email already taken", code: "email" });
            }
        }
        catch (err) {
            return response.status(500).json({ err });
        }
    }
    async createDelivery({ request, response }) {
        try {
            const existing_user = await User_1.default.findBy('user_email', request.body()['user_email']);
            if (!existing_user) {
                const user = await User_1.default.create({ user_firstname: request.body()['user_firstname'], user_lastname: request.body()['user_lastname'], user_email: request.body()['user_email'], password: request.body()['user_password'], user_phone_number: request.body()['user_phone_number'], user_is_supported: false, user_support: false, user_is_delivery: true });
                const role = await Role_1.default.findOrFail(2);
                await user.related('role').associate(role);
                return response.status(201).json({ user });
            }
            else {
                return response.status(400).json({ message: "email already taken", code: "email" });
            }
        }
        catch (err) {
            return response.status(500).json({ err });
        }
    }
    async createRestorer({ request, response }) {
        try {
            const existing_user = await User_1.default.findBy('user_email', request.body()['user_email']);
            if (!existing_user) {
                const user = await User_1.default.create({ user_firstname: request.body()['user_firstname'], user_lastname: request.body()['user_lastname'], user_email: request.body()['user_email'], password: request.body()['user_password'], user_phone_number: request.body()['user_phone_number'], user_is_supported: false, user_support: false, user_is_delivery: false });
                const role = await Role_1.default.findOrFail(3);
                await user.related('role').associate(role);
                const restorer = await Restorer_1.default.create({ restorer_name: request.body()['restorer_name'] });
                const address = await Address_1.default.create({ address_city: request.body()['restorer_address_city'], address_street: request.body()['restorer_address_street'], address_street_number: request.body()['restorer_address_street_number'], address_postal_code: request.body()['restorer_address_postal_code'] });
                await restorer.related('address').associate(address);
                await user.related('restorer').associate(restorer);
                return response.status(201).json({ user });
            }
            else {
                return response.status(400).json({ message: "email already taken", code: "email" });
            }
        }
        catch (err) {
            return response.status(500).json({ err });
        }
    }
    async update({ request, response, params }) {
        try {
            const user = await User_1.default.findOrFail(jsonwebtoken_1.default.verify(request.input('jwt'), 'TOKEN_PRIVATE_KEY')['user_id']);
            user.merge({ user_firstname: request.body()['user_firstname'], user_lastname: request.body()['user_lastname'], user_email: request.body()['user_email'], password: request.body()['user_password'], user_phone_number: request.body()['user_phone_number'] });
            await user.save();
            return response.status(200).json({ user });
        }
        catch (err) {
            return response.status(500).json({ err });
        }
    }
    async updateSponsor({ request, response, params }) {
        try {
            const user = await User_1.default.findOrFail(jsonwebtoken_1.default.verify(request.input('jwt'), 'TOKEN_PRIVATE_KEY')['user_id']);
            const filleul = await User_1.default.findBy('user_email', request.body()['filleul_email']);
            if (user.user_support == false && filleul && user.fk_role_id == filleul.fk_role_id) {
                if (filleul.user_is_supported == false) {
                    user.user_support = true;
                    await user.save();
                    filleul.user_is_supported = true;
                    await filleul.save();
                }
                else {
                    return response.status(400).json({ message: "error this user is already supported or you enter the wrong email" });
                }
                return response.status(200).json({ user });
            }
            else {
                return response.status(400).json({ message: "error Unable to find the user or the user is already supporting someone" });
            }
        }
        catch (err) {
            return response.status(500).json({ err });
        }
    }
    async delete({ response, request, params }) {
        try {
            const user = await User_1.default.findOrFail(jsonwebtoken_1.default.verify(request.input('jwt'), 'TOKEN_PRIVATE_KEY')['user_id']);
            await user.delete();
            return response.status(200).json({ user });
        }
        catch (err) {
            return response.status(500).json({ err: err, message: "wrong user" });
        }
    }
}
exports.default = UsersController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVXNlckNvbnRyb2xsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJVc2VyQ29udHJvbGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUNBLGlGQUFrQztBQUNsQyw2RkFBOEM7QUFDOUMsdUZBQXdDO0FBQ3hDLGlGQUFrQztBQUNsQyx5RkFBMEM7QUFDMUMsZ0VBQThCO0FBRzlCLE1BQXFCLGVBQWU7SUFXekIsS0FBSyxDQUFDLEtBQUssQ0FBRSxFQUFDLFFBQVEsRUFBQyxPQUFPLEVBQXFCO1FBQ3RELElBQUc7WUFDQyxNQUFNLElBQUksR0FBRyxNQUFNLGNBQUksQ0FBQyxVQUFVLENBQUMsc0JBQUcsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRSxtQkFBbUIsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUE7WUFDcEcsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLElBQUksQ0FBQyxFQUFDO2dCQUNqRCxNQUFNLEtBQUssR0FBRyxNQUFNLGNBQUksQ0FBQyxLQUFLLEVBQUU7cUJBQy9CLE9BQU8sQ0FBQyxNQUFNLENBQUM7cUJBQ2YsT0FBTyxDQUFDLGFBQWEsQ0FBQztxQkFDdEIsT0FBTyxDQUFDLHFCQUFxQixDQUFDO3FCQUM5QixPQUFPLENBQUMsb0JBQW9CLENBQUM7cUJBQzdCLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQTtnQkFDcEIsT0FBTyxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFDLEtBQUssRUFBQyxDQUFDLENBQUE7YUFDNUM7aUJBQUk7Z0JBQ0QsT0FBTyxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFDLE9BQU8sRUFBRSw4Q0FBOEMsRUFBQyxDQUFDLENBQUE7YUFDOUY7U0FFSjtRQUFBLE9BQU0s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RUFBQyxDQUFDLENBQUE7YUFDM0M7aUJBQUk7Z0JBQ0QsT0FBTyxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFDLE9BQU8sRUFBRSx5RUFBeUUsRUFBQyxDQUFDLENBQUE7YUFDekg7U0FDSjtRQUFBLE9BQU0sR0FBRyxFQUFDO1lBQ1AsT0FBTyxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFDLEdBQUcsRUFBQyxDQUFDLENBQUE7U0FDMUM7SUFDTCxDQUFDO0lBV00sS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFDLFFBQVEsRUFBQyxPQUFPLEVBQUUsTUFBTSxFQUFxQjtRQUM5RCxJQUFHO1lBQ0ssTUFBTSxJQUFJLEdBQUcsTUFBTSxjQUFJLENBQUMsVUFBVSxDQUFDLHNCQUFHLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUUsbUJBQW1CLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQ3JHLE1BQU0sSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ3BCLE9BQU8sUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBQyxJQUFJLEVBQUMsQ0FBQyxDQUFBO1NBQy9DO1FBQUEsT0FBTSxHQUFHLEVBQUM7WUFDUCxPQUFPLFFBQVEsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUMsWUFBWSxFQUFDLENBQUMsQ0FBQTtTQUNyRTtJQUVMLENBQUM7Q0FFSjtBQTNORCxrQ0EyTkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIdHRwQ29udGV4dENvbnRyYWN0IH0gZnJvbSAnQGlvYzpBZG9uaXMvQ29yZS9IdHRwQ29udGV4dCdcbmltcG9ydCBVc2VyIGZyb20gJ0FwcC9Nb2RlbHMvVXNlcidcbmltcG9ydCBDcmVkaXRDYXJkIGZyb20gJ0FwcC9Nb2RlbHMvQ3JlZGl0Q2FyZCdcbmltcG9ydCBBZGRyZXNzIGZyb20gJ0FwcC9Nb2RlbHMvQWRkcmVzcydcbmltcG9ydCBSb2xlIGZyb20gJ0FwcC9Nb2RlbHMvUm9sZSdcbmltcG9ydCBSZXN0b3JlciBmcm9tICdBcHAvTW9kZWxzL1Jlc3RvcmVyJ1xuaW1wb3J0IGp3dCBmcm9tICdqc29ud2VidG9rZW4nXG5cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVXNlcnNDb250cm9sbGVyIHtcblxuXG4gICAgLyoqXG4gICAgICogQGFwaSB7Z2V0fSAvdXNlcnMgUmVxdWVzdCBhbGwgdXNlcnNcbiAgICAgKiBAYXBpTmFtZSBpbmRleFxuICAgICAqIEBhcGlHcm91cCBVc2VyXG4gICAgICogQGFwaVN1Y2Nlc3Mge09iamVjdH0gdXNlciBvYmplY3QuXG4gICAgICogQGFwaUVycm9yICg1MDApIEVycm9yIEVycm9yIHRvIHJlcXVlc3QgZGF0YWJhc2UuXG4gICAgICogQGFwaUVycm9yICg0MDMpIEVycm9yIHlvdSBkb24ndCBoYXZlIHBlcm1pc3Npb24uXG4gICAgICovXG4gICAgcHVibGljIGFzeW5jIGluZGV4ICh7cmVzcG9uc2UscmVxdWVzdH06SHR0cENvbnRleHRDb250cmFjdCl7XG4gICAgICAgIHRyeXtcbiAgICAgICAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyLmZpbmRPckZhaWwoand0LnZlcmlmeShyZXF1ZXN0LmlucHV0KCdqd3QnKSwgJ1RPS0VOX1BSSVZBVEVfS0VZJylbJ3VzZXJfaWQnXSlcbiAgICAgICAgICAgIGlmICh1c2VyLnJvbGUucm9sZV9pZCA9PSA1IHx8IHVzZXIucm9sZS5yb2xlX2lkID09IDQpe1xuICAgICAgICAgICAgICAgIGNvbnN0IHVzZXJzID0gYXdhaXQgVXNlci5xdWVyeSgpXG4gICAgICAgICAgICAgICAgLnByZWxvYWQoJ3JvbGUnKVxuICAgICAgICAgICAgICAgIC5wcmVsb2FkKCdjcmVkaXRfY2FyZCcpXG4gICAgICAgICAgICAgICAgLnByZWxvYWQoJ2RlbGl2ZXJ5X2FkZHJlc3NfaWQnKVxuICAgICAgICAgICAgICAgIC5wcmVsb2FkKCdwYXltZW50X2FkZHJlc3NfaWQnKVxuICAgICAgICAgICAgICAgIC5wcmVsb2FkKCdyZXN0b3JlcicpXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cygyMDApLmpzb24oe3VzZXJzfSlcbiAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNDAzKS5qc29uKHttZXNzYWdlOiBcIkVycm9yIHlvdSBkb24ndCBoYXZlIHRoZSBjb3JyZWN0IHBlcm1pc3Npb25zXCJ9KVxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH1jYXRjaChlcnIpe1xuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg1MDApLmpzb24oe2Vycn0pXG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBhcGkge2dldH0gL3VzZXIgUmVxdWVzdCBhIHNwZWNpZmljIHVzZXIgdGhhbmtzIHRvIGhpcyB0b2tlblxuICAgICAqIEBhcGlOYW1lIGdldEJ5SWRcbiAgICAgKiBAYXBpR3JvdXAgVXNlclxuICAgICAqIEBhcGlQYXJhbSB7SW50ZWdlcn0gdXNlcl9pZCBvZiB0aGUgdXNlclxuICAgICAqIEBhcGlTdWNjZXNzIHtPYmplY3R9IHVzZXIgb2JqZWN0LlxuICAgICAqIEBhcGlFcnJvciAoNTAwKSBFcnJvciBFcnJvciB0byByZXF1ZXN0IGRhdGFiYXNlLlxuICAgICAqIEBhcGlFcnJvciAoNDAzKSBFcnJvciBFcnJvciB3cm9uZyB1c2VyIElELlxuICAgICAqL1xuICAgIHB1YmxpYyBhc3luYyBnZXRCeUlkICh7cGFyYW1zLHJlc3BvbnNlLCByZXF1ZXN0fTpIdHRwQ29udGV4dENvbnRyYWN0KXtcbiAgICAgICAgdHJ5e1xuICAgICAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZE9yRmFpbChqd3QudmVyaWZ5KHJlcXVlc3QuaW5wdXQoJ2p3dCcpLCAnVE9LRU5fUFJJVkFURV9LRVknKVsndXNlcl9pZCddKTtcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoMjAwKS5qc29uKHt1c2VyfSlcbiAgICAgICAgfWNhdGNoKGVycil7XG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDUwMCkuanNvbih7ZXJyfSlcbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQGFwaSB7cG9zdH0gL3VzZXIvY2xpZW50IGNyZWF0ZSBhIHVzZXIgd2l0aCB0aGUgY2xpZW50IHJvbGVcbiAgICAgKiBAYXBpTmFtZSBjcmVhdGVDbGllbnRcbiAgICAgKiBAYXBpR3JvdXAgVXNlclxuICAgICAqIEBhcGlTdWNjZXNzIHtPYmplY3R9IHVzZXIgb2JqZWN0LlxuICAgICAqIEBhcGlFcnJvciAoNTAwKSBFcnJvciBFcnJvciB0byByZXF1ZXN0IGRhdGFiYXNlLlxuICAgICAqIEBhcGlFcnJvciAoNDAwKSBFcnJvciBFbWFpbCBhbHJlYWR5IHRha2VuLlxuICAgICAqL1xuICAgIHB1YmxpYyBhc3luYyBjcmVhdGVDbGllbnQoeyByZXF1ZXN0ICwgcmVzcG9uc2UgfTpIdHRwQ29udGV4dENvbnRyYWN0KXtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgZXhpc3RpbmdfdXNlciA9IGF3YWl0IFVzZXIuZmluZEJ5KCd1c2VyX2VtYWlsJywgcmVxdWVzdC5ib2R5KClbJ3VzZXJfZW1haWwnXSlcbiAgICAgICAgICAgIGlmKCFleGlzdGluZ191c2VyKXtcbiAgICAgICAgICAgICAgICBjb25zdCB1c2VyID0gYXdhaXQgVXNlci5jcmVhdGUoe3VzZXJfZmlyc3RuYW1lOnJlcXVlc3QuYm9keSgpWyd1c2VyX2ZpcnN0bmFtZSddLHVzZXJfbGFzdG5hbWU6cmVxdWVzdC5ib2R5KClbJ3VzZXJfbGFzdG5hbWUnXSx1c2VyX2VtYWlsOnJlcXVlc3QuYm9keSgpWyd1c2VyX2VtYWlsJ10scGFzc3dvcmQ6cmVxdWVzdC5ib2R5KClbJ3VzZXJfcGFzc3dvcmQnXSx1c2VyX3Bob25lX251bWJlcjpyZXF1ZXN0LmJvZHkoKVsndXNlcl9waG9uZV9udW1iZXInXSwgdXNlcl9pc19zdXBwb3J0ZWQ6ZmFsc2UsdXNlcl9zdXBwb3J0OmZhbHNlLHVzZXJfaXNfZGVsaXZlcnk6ZmFsc2V9KTtcblxuICAgICAgICAgICAgICAgIGlmIChyZXF1ZXN0LmJvZHkoKVsnZGVsaXZlcnlfYWRkcmVzc19jaXR5J10hPSB1bmRlZmluZWQgJiYgcmVxdWVzdC5ib2R5KClbJ2RlbGl2ZXJ5X2FkZHJlc3Nfc3RyZWV0J10hPSB1bmRlZmluZWQgJiYgcmVxdWVzdC5ib2R5KClbJ2RlbGl2ZXJ5X2FkZHJlc3NfcG9zdGFsX2NvZGUnXSE9IHVuZGVmaW5lZCAmJiByZXF1ZXN0LmJvZHkoKVsnZGVsaXZlcnlfYWRkcmVzc19zdHJlZXRfbnVtYmVyJ10hPSB1bmRlZmluZWQpe1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBkZWxpdmVyeV9hZGRyZXNzID0gYXdhaXQgQWRkcmVzcy5jcmVhdGUoe2FkZHJlc3NfY2l0eTogcmVxdWVzdC5ib2R5KClbJ2RlbGl2ZXJ5X2FkZHJlc3NfY2l0eSddLCBhZGRyZXNzX3N0cmVldDogcmVxdWVzdC5ib2R5KClbJ2RlbGl2ZXJ5X2FkZHJlc3Nfc3RyZWV0J10sIGFkZHJlc3Nfc3RyZWV0X251bWJlcjogcmVxdWVzdC5ib2R5KClbJ2RlbGl2ZXJ5X2FkZHJlc3Nfc3RyZWV0X251bWJlciddLCBhZGRyZXNzX3Bvc3RhbF9jb2RlOnJlcXVlc3QuYm9keSgpWydkZWxpdmVyeV9hZGRyZXNzX3Bvc3RhbF9jb2RlJ10gfSk7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHVzZXIucmVsYXRlZCgnZGVsaXZlcnlfYWRkcmVzc19pZCcpLmFzc29jaWF0ZShkZWxpdmVyeV9hZGRyZXNzKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocmVxdWVzdC5ib2R5KClbJ3BheW1lbnRfYWRkcmVzc19jaXR5J10hPSB1bmRlZmluZWQgJiYgcmVxdWVzdC5ib2R5KClbJ3BheW1lbnRfYWRkcmVzc19zdHJlZXQnXSE9IHVuZGVmaW5lZCAmJiByZXF1ZXN0LmJvZHkoKVsncGF5bWVudF9hZGRyZXNzX3Bvc3RhbF9jb2RlJ10hPSB1bmRlZmluZWQgJiYgcmVxdWVzdC5ib2R5KClbJ3BheW1lbnRfYWRkcmVzc19zdHJlZXRfbnVtYmVyJ10hPSB1bmRlZmluZWQpe1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBwYXltZW50X2FkZHJlc3MgPSBhd2FpdCBBZGRyZXNzLmNyZWF0ZSh7YWRkcmVzc19jaXR5OiByZXF1ZXN0LmJvZHkoKVsncGF5bWVudF9hZGRyZXNzX2NpdHknXSwgYWRkcmVzc19zdHJlZXQ6IHJlcXVlc3QuYm9keSgpWydwYXltZW50X2FkZHJlc3Nfc3RyZWV0J10sIGFkZHJlc3Nfc3RyZWV0X251bWJlcjogcmVxdWVzdC5ib2R5KClbJ3BheW1lbnRfYWRkcmVzc19zdHJlZXRfbnVtYmVyJ10sIGFkZHJlc3NfcG9zdGFsX2NvZGU6cmVxdWVzdC5ib2R5KClbJ3BheW1lbnRfYWRkcmVzc19wb3N0YWxfY29kZSddIH0pO1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCB1c2VyLnJlbGF0ZWQoJ3BheW1lbnRfYWRkcmVzc19pZCcpLmFzc29jaWF0ZShwYXltZW50X2FkZHJlc3MpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChyZXF1ZXN0LmJvZHkoKVsnY3JlZGl0X2NhcmRfdHlwZSddIT11bmRlZmluZWQgJiYgcmVxdWVzdC5ib2R5KClbJ2NyZWRpdF9jYXJkX251bSddIT11bmRlZmluZWQgKXtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY3JlZGl0Y2FyZCA9IGF3YWl0IENyZWRpdENhcmQuY3JlYXRlKHtjcmVkaXRfY2FyZF90eXBlOiByZXF1ZXN0LmJvZHkoKVsnY3JlZGl0X2NhcmRfdHlwZSddLCBjcmVkaXRfY2FyZF9udW0gOiByZXF1ZXN0LmJvZHkoKVsnY3JlZGl0X2NhcmRfbnVtJ10gfSk7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHVzZXIucmVsYXRlZCgnY3JlZGl0X2NhcmQnKS5hc3NvY2lhdGUoY3JlZGl0Y2FyZClcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY29uc3Qgcm9sZSA9IGF3YWl0IFJvbGUuZmluZE9yRmFpbCgxKVxuICAgICAgICAgICAgICAgIGF3YWl0IHVzZXIucmVsYXRlZCgncm9sZScpLmFzc29jaWF0ZShyb2xlKVxuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoMjAxKS5qc29uKHt1c2VyfSlcbiAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNDAwKS5qc29uKHttZXNzYWdlOiBcImVtYWlsIGFscmVhZHkgdGFrZW5cIiwgY29kZTpcImVtYWlsXCJ9KVxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH1jYXRjaChlcnIpe1xuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg1MDApLmpzb24oe2Vycn0pXG4gICAgICAgIH1cblxuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQGFwaSB7cG9zdH0gL3VzZXIvZGVsaXZlcnkgY3JlYXRlIGEgdXNlciB3aXRoIHRoZSBkZWxpdmVyeSBtYW4gcm9sZVxuICAgICAqIEBhcGlOYW1lIGNyZWF0ZURlbGl2ZXJ5XG4gICAgICogQGFwaUdyb3VwIFVzZXJcbiAgICAgKiBAYXBpU3VjY2VzcyB7T2JqZWN0fSB1c2VyIG9iamVjdC5cbiAgICAgKiBAYXBpRXJyb3IgKDUwMCkgRXJyb3IgRXJyb3IgdG8gcmVxdWVzdCBkYXRhYmFzZS5cbiAgICAgKiBAYXBpRXJyb3IgKDQwMCkgRXJyb3IgRW1haWwgYWxyZWFkeSB0YWtlbi5cbiAgICAgKi9cbiAgICBwdWJsaWMgYXN5bmMgY3JlYXRlRGVsaXZlcnkoeyByZXF1ZXN0ICwgcmVzcG9uc2UgfTpIdHRwQ29udGV4dENvbnRyYWN0KXtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGV4aXN0aW5nX3VzZXIgPSBhd2FpdCBVc2VyLmZpbmRCeSgndXNlcl9lbWFpbCcsIHJlcXVlc3QuYm9keSgpWyd1c2VyX2VtYWlsJ10pXG4gICAgICAgICAgICBpZighZXhpc3RpbmdfdXNlcil7XG4gICAgICAgICAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuY3JlYXRlKHt1c2VyX2ZpcnN0bmFtZTpyZXF1ZXN0LmJvZHkoKVsndXNlcl9maXJzdG5hbWUnXSx1c2VyX2xhc3RuYW1lOnJlcXVlc3QuYm9keSgpWyd1c2VyX2xhc3RuYW1lJ10sdXNlcl9lbWFpbDpyZXF1ZXN0LmJvZHkoKVsndXNlcl9lbWFpbCddLHBhc3N3b3JkOnJlcXVlc3QuYm9keSgpWyd1c2VyX3Bhc3N3b3JkJ10sdXNlcl9waG9uZV9udW1iZXI6cmVxdWVzdC5ib2R5KClbJ3VzZXJfcGhvbmVfbnVtYmVyJ10sIHVzZXJfaXNfc3VwcG9ydGVkOmZhbHNlLHVzZXJfc3VwcG9ydDpmYWxzZSx1c2VyX2lzX2RlbGl2ZXJ5OnRydWV9KTtcbiAgICAgICAgICAgIGNvbnN0IHJvbGUgPSBhd2FpdCBSb2xlLmZpbmRPckZhaWwoMilcbiAgICAgICAgICAgIGF3YWl0IHVzZXIucmVsYXRlZCgncm9sZScpLmFzc29jaWF0ZShyb2xlKVxuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cygyMDEpLmpzb24oe3VzZXJ9KVxuICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg0MDApLmpzb24oe21lc3NhZ2U6IFwiZW1haWwgYWxyZWFkeSB0YWtlblwiLCBjb2RlOlwiZW1haWxcIn0pXG4gICAgICAgICAgICB9XG4gICAgICAgIH1jYXRjaChlcnIpe1xuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg1MDApLmpzb24oe2Vycn0pXG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBhcGkge3Bvc3R9IC91c2VyL2RlbGl2ZXJ5IGNyZWF0ZSBhIHVzZXIgd2l0aCB0aGUgcmVzdG9yZXIgcm9sZVxuICAgICAqIEBhcGlOYW1lIGNyZWF0ZVJlc3RvcmVyXG4gICAgICogQGFwaUdyb3VwIFVzZXJcbiAgICAgKiBAYXBpU3VjY2VzcyB7T2JqZWN0fSB1c2VyIG9iamVjdC5cbiAgICAgKiBAYXBpRXJyb3IgKDUwMCkgRXJyb3IgRXJyb3IgdG8gcmVxdWVzdCBkYXRhYmFzZS5cbiAgICAgKiBAYXBpRXJyb3IgKDQwMCkgRXJyb3IgRW1haWwgYWxyZWFkeSB0YWtlbi5cbiAgICAgKi9cbiAgICBwdWJsaWMgYXN5bmMgY3JlYXRlUmVzdG9yZXIoeyByZXF1ZXN0ICwgcmVzcG9uc2UgfTpIdHRwQ29udGV4dENvbnRyYWN0KXtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGV4aXN0aW5nX3VzZXIgPSBhd2FpdCBVc2VyLmZpbmRCeSgndXNlcl9lbWFpbCcsIHJlcXVlc3QuYm9keSgpWyd1c2VyX2VtYWlsJ10pXG4gICAgICAgICAgICBpZighZXhpc3RpbmdfdXNlcil7XG4gICAgICAgICAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuY3JlYXRlKHt1c2VyX2ZpcnN0bmFtZTpyZXF1ZXN0LmJvZHkoKVsndXNlcl9maXJzdG5hbWUnXSx1c2VyX2xhc3RuYW1lOnJlcXVlc3QuYm9keSgpWyd1c2VyX2xhc3RuYW1lJ10sdXNlcl9lbWFpbDpyZXF1ZXN0LmJvZHkoKVsndXNlcl9lbWFpbCddLHBhc3N3b3JkOnJlcXVlc3QuYm9keSgpWyd1c2VyX3Bhc3N3b3JkJ10sdXNlcl9waG9uZV9udW1iZXI6cmVxdWVzdC5ib2R5KClbJ3VzZXJfcGhvbmVfbnVtYmVyJ10sIHVzZXJfaXNfc3VwcG9ydGVkOmZhbHNlLHVzZXJfc3VwcG9ydDpmYWxzZSx1c2VyX2lzX2RlbGl2ZXJ5OmZhbHNlfSk7XG4gICAgICAgICAgICAgICAgY29uc3Qgcm9sZSA9IGF3YWl0IFJvbGUuZmluZE9yRmFpbCgzKVxuICAgICAgICAgICAgICAgIGF3YWl0IHVzZXIucmVsYXRlZCgncm9sZScpLmFzc29jaWF0ZShyb2xlKVxuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3RvcmVyID0gYXdhaXQgUmVzdG9yZXIuY3JlYXRlKHtyZXN0b3Jlcl9uYW1lIDogcmVxdWVzdC5ib2R5KClbJ3Jlc3RvcmVyX25hbWUnXX0pXG4gICAgICAgICAgICAgICAgY29uc3QgYWRkcmVzcyA9IGF3YWl0IEFkZHJlc3MuY3JlYXRlKHthZGRyZXNzX2NpdHk6IHJlcXVlc3QuYm9keSgpWydyZXN0b3Jlcl9hZGRyZXNzX2NpdHknXSwgYWRkcmVzc19zdHJlZXQ6IHJlcXVlc3QuYm9keSgpWydyZXN0b3Jlcl9hZGRyZXNzX3N0cmVldCddLCBhZGRyZXNzX3N0cmVldF9udW1iZXI6IHJlcXVlc3QuYm9keSgpWydyZXN0b3Jlcl9hZGRyZXNzX3N0cmVldF9udW1iZXInXSwgYWRkcmVzc19wb3N0YWxfY29kZTpyZXF1ZXN0LmJvZHkoKVsncmVzdG9yZXJfYWRkcmVzc19wb3N0YWxfY29kZSddIH0pXG4gICAgICAgICAgICAgICAgYXdhaXQgcmVzdG9yZXIucmVsYXRlZCgnYWRkcmVzcycpLmFzc29jaWF0ZShhZGRyZXNzKVxuICAgICAgICAgICAgICAgIGF3YWl0IHVzZXIucmVsYXRlZCgncmVzdG9yZXInKS5hc3NvY2lhdGUocmVzdG9yZXIpXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cygyMDEpLmpzb24oe3VzZXJ9KVxuXG4gICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDQwMCkuanNvbih7bWVzc2FnZTogXCJlbWFpbCBhbHJlYWR5IHRha2VuXCIsIGNvZGU6XCJlbWFpbFwifSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgfWNhdGNoKGVycil7XG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDUwMCkuanNvbih7ZXJyfSlcbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQGFwaSB7cHV0fSAvdXNlci86aWQgdXBkYXRlIHRoZSBzcGVjaWZpZWQgdXNlclxuICAgICAqIEBhcGlOYW1lIHVwZGF0ZVxuICAgICAqIEBhcGlHcm91cCBVc2VyXG4gICAgICogQGFwaVBhcmFtIHtJbnRlZ2VyfSB1c2VyX2lkIElkIG9mIHRoZSB1c2VyLlxuICAgICAqIEBhcGlTdWNjZXNzIHtPYmplY3R9IHVzZXIgb2JqZWN0LlxuICAgICAqIEBhcGlFcnJvciAoNTAwKSBFcnJvciBFcnJvciB0byByZXF1ZXN0IGRhdGFiYXNlLlxuICAgICAqL1xuICAgIHB1YmxpYyBhc3luYyB1cGRhdGUgKHtyZXF1ZXN0LCByZXNwb25zZSwgcGFyYW1zfTpIdHRwQ29udGV4dENvbnRyYWN0KXtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyLmZpbmRPckZhaWwoand0LnZlcmlmeShyZXF1ZXN0LmlucHV0KCdqd3QnKSwgJ1RPS0VOX1BSSVZBVEVfS0VZJylbJ3VzZXJfaWQnXSk7XG4gICAgICAgICAgICB1c2VyLm1lcmdlKHt1c2VyX2ZpcnN0bmFtZTpyZXF1ZXN0LmJvZHkoKVsndXNlcl9maXJzdG5hbWUnXSx1c2VyX2xhc3RuYW1lOnJlcXVlc3QuYm9keSgpWyd1c2VyX2xhc3RuYW1lJ10sdXNlcl9lbWFpbDpyZXF1ZXN0LmJvZHkoKVsndXNlcl9lbWFpbCddLHBhc3N3b3JkOnJlcXVlc3QuYm9keSgpWyd1c2VyX3Bhc3N3b3JkJ10sdXNlcl9waG9uZV9udW1iZXI6cmVxdWVzdC5ib2R5KClbJ3VzZXJfcGhvbmVfbnVtYmVyJ119KTtcbiAgICAgICAgICAgIGF3YWl0IHVzZXIuc2F2ZSgpO1xuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cygyMDApLmpzb24oe3VzZXJ9KVxuICAgICAgICB9Y2F0Y2goZXJyKXtcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNTAwKS5qc29uKHtlcnJ9KVxuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAYXBpIHtwdXR9IC91c2VyLzppZCB1cGRhdGUgdGhlIHNwZWNpZmllZCB1c2VyIGZvciBzcG9uc29yaW5nXG4gICAgICogQGFwaU5hbWUgdXBkYXRlU3BvbnNvclxuICAgICAqIEBhcGlHcm91cCBVc2VyXG4gICAgICogQGFwaVBhcmFtIHtJbnRlZ2VyfSB1c2VyX2lkIElkIG9mIHRoZSB1c2VyLlxuICAgICAqIEBhcGlTdWNjZXNzIHtPYmplY3R9IHVzZXIgb2JqZWN0LlxuICAgICAqIEBhcGlFcnJvciAoNTAwKSBFcnJvciBFcnJvciB0byByZXF1ZXN0IGRhdGFiYXNlLlxuICAgICAqIEBhcGlFcnJvciAoNDAwKSBlcnJvciB0aGlzIHVzZXIgaXMgYWxyZWFkeSBzdXBwb3J0ZWQgb3IgeW91IGVudGVyIHRoZSB3cm9uZyBlbWFpbFxuICAgICAqIEBhcGlFcnJvciAoNDAwKSBlcnJvciBVbmFibGUgdG8gZmluZCB0aGUgdXNlciBvciB0aGUgdXNlciBpcyBhbHJlYWR5IHN1cHBvcnRpbmcgc29tZW9uZVxuICAgICAqL1xuICAgICBwdWJsaWMgYXN5bmMgdXBkYXRlU3BvbnNvciAoe3JlcXVlc3QsIHJlc3BvbnNlLCBwYXJhbXN9Okh0dHBDb250ZXh0Q29udHJhY3Qpe1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZE9yRmFpbChqd3QudmVyaWZ5KHJlcXVlc3QuaW5wdXQoJ2p3dCcpLCAnVE9LRU5fUFJJVkFURV9LRVknKVsndXNlcl9pZCddKTtcbiAgICAgICAgICAgIGNvbnN0IGZpbGxldWwgPSBhd2FpdCBVc2VyLmZpbmRCeSgndXNlcl9lbWFpbCcsIHJlcXVlc3QuYm9keSgpWydmaWxsZXVsX2VtYWlsJ10pXG4gICAgICAgICAgICBpZiAodXNlci51c2VyX3N1cHBvcnQ9PWZhbHNlICYmIGZpbGxldWwgJiYgdXNlci5ma19yb2xlX2lkID09IGZpbGxldWwuZmtfcm9sZV9pZCl7XG4gICAgICAgICAgICAgICAgaWYgKGZpbGxldWwudXNlcl9pc19zdXBwb3J0ZWQgPT0gZmFsc2Upe1xuICAgICAgICAgICAgICAgICAgICB1c2VyLnVzZXJfc3VwcG9ydCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHVzZXIuc2F2ZSgpO1xuICAgICAgICAgICAgICAgICAgICBmaWxsZXVsLnVzZXJfaXNfc3VwcG9ydGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgZmlsbGV1bC5zYXZlKCk7XG4gICAgICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNDAwKS5qc29uKHttZXNzYWdlOiBcImVycm9yIHRoaXMgdXNlciBpcyBhbHJlYWR5IHN1cHBvcnRlZCBvciB5b3UgZW50ZXIgdGhlIHdyb25nIGVtYWlsXCJ9KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDIwMCkuanNvbih7dXNlcn0pXG4gICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDQwMCkuanNvbih7bWVzc2FnZTogXCJlcnJvciBVbmFibGUgdG8gZmluZCB0aGUgdXNlciBvciB0aGUgdXNlciBpcyBhbHJlYWR5IHN1cHBvcnRpbmcgc29tZW9uZVwifSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgfWNhdGNoKGVycil7XG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDUwMCkuanNvbih7ZXJyfSlcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBhcGkge2RlbGV0ZX0gL3VzZXIvOmlkIGRlbGV0ZSB0aGUgc3BlY2lmaWVkIHVzZXJcbiAgICAgKiBAYXBpTmFtZSBkZWxldGVcbiAgICAgKiBAYXBpR3JvdXAgVXNlclxuICAgICAqIEBhcGlQYXJhbSB7SW50ZWdlcn0gdXNlcl9pZCAgb2YgdGhlIHVzZXIuXG4gICAgICogQGFwaVN1Y2Nlc3Mge09iamVjdH0gdXNlciBvYmplY3QuXG4gICAgICogQGFwaUVycm9yICg1MDApIEVycm9yIEVycm9yIHRvIHJlcXVlc3QgZGF0YWJhc2UuXG4gICAgICogQGFwaUVycm9yICg0MDMpIFdyb25nIHVzZXIgSUQuXG4gICAgICovXG4gICAgcHVibGljIGFzeW5jIGRlbGV0ZSh7cmVzcG9uc2UscmVxdWVzdCwgcGFyYW1zfTpIdHRwQ29udGV4dENvbnRyYWN0KXtcbiAgICAgICAgdHJ5e1xuICAgICAgICAgICAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyLmZpbmRPckZhaWwoand0LnZlcmlmeShyZXF1ZXN0LmlucHV0KCdqd3QnKSwgJ1RPS0VOX1BSSVZBVEVfS0VZJylbJ3VzZXJfaWQnXSk7XG4gICAgICAgICAgICAgICAgYXdhaXQgdXNlci5kZWxldGUoKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDIwMCkuanNvbih7dXNlcn0pXG4gICAgICAgIH1jYXRjaChlcnIpe1xuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg1MDApLmpzb24oe2VycjogZXJyLCBtZXNzYWdlOlwid3JvbmcgdXNlclwifSlcbiAgICAgICAgfVxuXG4gICAgfVxuXG59XG4iXX0=