"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const User_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/User"));
const CreditCard_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/CreditCard"));
const Address_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/Address"));
const Role_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/Role"));
const Restorer_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/Restorer"));
const jsonwebtoken_1 = __importDefault(require("jsonwebtoken"));
class UsersController {
    async index({ response, request }) {
        try {
            const user = await User_1.default.findOrFail(jsonwebtoken_1.default.verify(request.input('jwt'), 'TOKEN_PRIVATE_KEY')['user_id']);
            if (user.role.role_id == 5 || user.role.role_id == 4) {
                const users = await User_1.default.query()
                    .preload('role')
                    .preload('credit_card')
                    .preload('delivery_address_id')
                    .preload('payment_address_id')
                    .preload('restorer');
                return response.status(200).json({ users });
            }
            else {
                return response.status(403).json({ message: "Error you don't have the correct permissions" });
            }
        }
        catch (err) {
            return response.status(500).json({ err });
        }
    }
    async getById({ params, response, request }) {
        try {
            if (jsonwebtoken_1.default.verify(request.input('jwt'), 'TOKEN_PRIVATE_KEY')['user_id'] == params.id) {
                const user = await User_1.default.findOrFail(params.id);
                return response.status(200).json({ user });
            }
            else {
                return response.status(403).json({ message: "Error wrong user ID" });
            }
        }
        catch (err) {
            return response.status(500).json({ err });
        }
    }
    async createClient({ request, response }) {
        try {
            const user = await User_1.default.create({ user_firstname: request.body()['user_firstname'], user_lastname: request.body()['user_lastname'], user_email: request.body()['user_email'], user_password: request.body()['user_password'], user_phone_number: request.body()['user_phone_number'], user_is_supported: request.body()['user_is_supported'], user_support: request.body()['user_support'], user_is_delivery: false });
            if (request.body()['delivery_address_city'] != undefined && request.body()['delivery_address_street'] != undefined && request.body()['delivery_address_postal_code'] != undefined && request.body()['delivery_address_street_number'] != undefined) {
                const delivery_address = await Address_1.default.create({ address_city: request.body()['delivery_address_city'], address_street: request.body()['delivery_address_street'], address_street_number: request.body()['delivery_address_street_number'], address_postal_code: request.body()['delivery_address_postal_code'] });
                await user.related('delivery_address_id').associate(delivery_address);
            }
            if (request.body()['payment_address_city'] != undefined && request.body()['payment_address_street'] != undefined && request.body()['payment_address_postal_code'] != undefined && request.body()['payment_address_street_number'] != undefined) {
                const payment_address = await Address_1.default.create({ address_city: request.body()['payment_address_city'], address_street: request.body()['payment_address_street'], address_street_number: request.body()['payment_address_street_number'], address_postal_code: request.body()['payment_address_postal_code'] });
                await user.related('payment_address_id').associate(payment_address);
            }
            if (request.body()['credit_card_type'] != undefined && request.body()['credit_card_num'] != undefined) {
                const creditcard = await CreditCard_1.default.create({ credit_card_type: request.body()['credit_card_type'], credit_card_num: request.body()['credit_card_num'] });
                await user.related('credit_card').associate(creditcard);
            }
            const role = await Role_1.default.findOrFail(1);
            await user.related('role').associate(role);
            return response.status(201).json({ user });
        }
        catch (err) {
            return response.status(500).json({ err });
        }
    }
    async createDelivery({ request, response }) {
        try {
            const user = await User_1.default.create({ user_firstname: request.body()['user_firstname'], user_lastname: request.body()['user_lastname'], user_email: request.body()['user_email'], user_password: request.body()['user_password'], user_phone_number: request.body()['user_phone_number'], user_is_supported: request.body()['user_is_supported'], user_support: request.body()['user_support'], user_is_delivery: true });
            const role = await Role_1.default.findOrFail(2);
            await user.related('role').associate(role);
            return response.status(201).json({ user });
        }
        catch (err) {
            return response.status(500).json({ err });
        }
    }
    async createRestorer({ request, response }) {
        try {
            const user = await User_1.default.create({ user_firstname: request.body()['user_firstname'], user_lastname: request.body()['user_lastname'], user_email: request.body()['user_email'], user_password: request.body()['user_password'], user_phone_number: request.body()['user_phone_number'], user_is_supported: false, user_support: false, user_is_delivery: false });
            const role = await Role_1.default.findOrFail(3);
            await user.related('role').associate(role);
            const restorer = await Restorer_1.default.create({ restorer_name: request.body()['restorer_name'] });
            const address = await Address_1.default.create({ address_city: request.body()['restorer_address_city'], address_street: request.body()['restorer_address_street'], address_street_number: request.body()['restorer_address_street_number'], address_postal_code: request.body()['restorer_address_postal_code'] });
            await restorer.related('address').associate(address);
            await user.related('restorer').associate(restorer);
            return response.status(201).json({ user });
        }
        catch (err) {
            return response.status(500).json({ err });
        }
    }
    async update({ request, response, params }) {
        try {
            if (jsonwebtoken_1.default.verify(request.input('jwt'), 'TOKEN_PRIVATE_KEY')['user_id'] == params.id) {
                const user = await User_1.default.findOrFail(params.id);
                user.merge({ user_firstname: request.body()['user_firstname'], user_lastname: request.body()['user_lastname'], user_email: request.body()['user_email'], user_password: request.body()['user_password'], user_phone_number: request.body()['user_phone_number'] });
                await user.save();
                return response.status(200).json({ user });
            }
            else {
                return response.status(403).json({ message: "Error wrong user ID" });
            }
        }
        catch (err) {
            return response.status(500).json({ err });
        }
    }
    async updateSponsor({ request, response, params }) {
        try {
            if (jsonwebtoken_1.default.verify(request.input('jwt'), 'TOKEN_PRIVATE_KEY')['user_id'] == params.id) {
                const user = await User_1.default.findOrFail(params.id);
                const filleul = await User_1.default.findBy('user_email', request.body()['filleul_email']);
                if (user.user_support == false && filleul && user.fk_role_id == filleul.fk_role_id) {
                    if (filleul.user_is_supported == false) {
                        user.user_support = true;
                        await user.save();
                        filleul.user_is_supported = true;
                        await filleul.save();
                    }
                    else {
                        return response.status(400).json({ message: "error this user is already supported or you enter the wrong email" });
                    }
                    return response.status(200).json({ user });
                }
                else {
                    return response.status(400).json({ message: "error Unable to find the user or the user is already supporting someone" });
                }
            }
            else {
                return response.status(403).json({ message: "Error wrong user ID" });
            }
        }
        catch (err) {
            return response.status(500).json({ err });
        }
    }
    async delete({ response, request, params }) {
        try {
            if (jsonwebtoken_1.default.verify(request.input('jwt'), 'TOKEN_PRIVATE_KEY')['user_id'] == params.id) {
                const user = await User_1.default.findOrFail(params.id);
                await user.delete();
                return response.status(200).json({ user });
            }
            else {
                return response.status(403).json({ message: "Error wrong user ID" });
            }
        }
        catch (err) {
            return response.status(500).json({ err });
        }
    }
}
exports.default = UsersController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVXNlckNvbnRyb2xsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJVc2VyQ29udHJvbGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUNBLGlGQUFrQztBQUNsQyw2RkFBOEM7QUFDOUMsdUZBQXdDO0FBQ3hDLGlGQUFrQztBQUNsQyx5RkFBMEM7QUFDMUMsZ0VBQThCO0FBRzlCLE1BQXFCLGVBQWU7SUFXekIsS0FBSyxDQUFDLEtBQUssQ0FBRSxFQUFDLFFBQVEsRUFBQyxPQUFPLEVBQXFCO1FBQ3RELElBQUc7WUFDQyxNQUFNLElBQUksR0FBRyxNQUFNLGNBQUksQ0FBQyxVQUFVLENBQUMsc0JBQUcsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRSxtQkFBbUIsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUE7WUFDcEcsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLElBQUksQ0FBQyxFQUFDO2dCQUNqRCxNQUFNLEtBQUssR0FBRyxNQUFNLGNBQUksQ0FBQyxLQUFLLEVBQUU7cUJBQy9CLE9BQU8sQ0FBQyxNQUFNLENBQUM7cUJBQ2YsT0FBTyxDQUFDLGFBQWEsQ0FBQztxQkFDdEIsT0FBTyxDQUFDLHFCQUFxQixDQUFDO3FCQUM5QixPQUFPLENBQUMsb0JBQW9CLENBQUM7cUJBQzdCLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQTtnQkFDcEIsT0FBTyxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFDLEtBQUssRUFBQyxDQUFDLENBQUE7YUFDNUM7aUJBQUk7Z0JBQ0QsT0FBTyxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFDLE9BQU8sRUFBRSw4Q0FBOEMsRUFBQyxDQUFDLENBQUE7YUFDOUY7U0FFSjtRQUFBLE9BQU0s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QUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUMsR0FBRyxFQUFDLENBQUMsQ0FBQTtTQUMxQztJQUVMLENBQUM7SUFXTSxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQUMsUUFBUSxFQUFDLE9BQU8sRUFBRSxNQUFNLEVBQXFCO1FBQzlELElBQUc7WUFDQyxJQUFJLHNCQUFHLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUUsbUJBQW1CLENBQUMsQ0FBQyxTQUFTLENBQUMsSUFBSSxNQUFNLENBQUMsRUFBRSxFQUFDO2dCQUM5RSxNQUFNLElBQUksR0FBRyxNQUFNLGNBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUM5QyxNQUFNLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztnQkFDcEIsT0FBTyxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFDLElBQUksRUFBQyxDQUFDLENBQUE7YUFDM0M7aUJBQUk7Z0JBQ0QsT0FBTyxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFDLE9BQU8sRUFBRSxxQkFBcUIsRUFBQyxDQUFDLENBQUE7YUFDckU7U0FFSjtRQUFBLE9BQU0sR0FBRyxFQUFDO1lBQ1AsT0FBTyxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFDLEdBQUcsRUFBQyxDQUFDLENBQUE7U0FDMUM7SUFFTCxDQUFDO0NBRUo7QUFoT0Qsa0NBZ09DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSHR0cENvbnRleHRDb250cmFjdCB9IGZyb20gJ0Bpb2M6QWRvbmlzL0NvcmUvSHR0cENvbnRleHQnXG5pbXBvcnQgVXNlciBmcm9tICdBcHAvTW9kZWxzL1VzZXInXG5pbXBvcnQgQ3JlZGl0Q2FyZCBmcm9tICdBcHAvTW9kZWxzL0NyZWRpdENhcmQnXG5pbXBvcnQgQWRkcmVzcyBmcm9tICdBcHAvTW9kZWxzL0FkZHJlc3MnXG5pbXBvcnQgUm9sZSBmcm9tICdBcHAvTW9kZWxzL1JvbGUnXG5pbXBvcnQgUmVzdG9yZXIgZnJvbSAnQXBwL01vZGVscy9SZXN0b3JlcidcbmltcG9ydCBqd3QgZnJvbSAnanNvbndlYnRva2VuJ1xuXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFVzZXJzQ29udHJvbGxlciB7XG5cblxuICAgIC8qKlxuICAgICAqIEBhcGkge2dldH0gL3VzZXJzIFJlcXVlc3QgYWxsIHVzZXJzXG4gICAgICogQGFwaU5hbWUgaW5kZXhcbiAgICAgKiBAYXBpR3JvdXAgVXNlclxuICAgICAqIEBhcGlTdWNjZXNzIHtPYmplY3R9IHVzZXIgb2JqZWN0LlxuICAgICAqIEBhcGlFcnJvciAoNTAwKSBFcnJvciBFcnJvciB0byByZXF1ZXN0IGRhdGFiYXNlLlxuICAgICAqIEBhcGlFcnJvciAoNDAzKSBFcnJvciB5b3UgZG9uJ3QgaGF2ZSBwZXJtaXNzaW9uLlxuICAgICAqL1xuICAgIHB1YmxpYyBhc3luYyBpbmRleCAoe3Jlc3BvbnNlLHJlcXVlc3R9Okh0dHBDb250ZXh0Q29udHJhY3Qpe1xuICAgICAgICB0cnl7XG4gICAgICAgICAgICBjb25zdCB1c2VyID0gYXdhaXQgVXNlci5maW5kT3JGYWlsKGp3dC52ZXJpZnkocmVxdWVzdC5pbnB1dCgnand0JyksICdUT0tFTl9QUklWQVRFX0tFWScpWyd1c2VyX2lkJ10pXG4gICAgICAgICAgICBpZiAodXNlci5yb2xlLnJvbGVfaWQgPT0gNSB8fCB1c2VyLnJvbGUucm9sZV9pZCA9PSA0KXtcbiAgICAgICAgICAgICAgICBjb25zdCB1c2VycyA9IGF3YWl0IFVzZXIucXVlcnkoKVxuICAgICAgICAgICAgICAgIC5wcmVsb2FkKCdyb2xlJylcbiAgICAgICAgICAgICAgICAucHJlbG9hZCgnY3JlZGl0X2NhcmQnKVxuICAgICAgICAgICAgICAgIC5wcmVsb2FkKCdkZWxpdmVyeV9hZGRyZXNzX2lkJylcbiAgICAgICAgICAgICAgICAucHJlbG9hZCgncGF5bWVudF9hZGRyZXNzX2lkJylcbiAgICAgICAgICAgICAgICAucHJlbG9hZCgncmVzdG9yZXInKVxuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoMjAwKS5qc29uKHt1c2Vyc30pXG4gICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDQwMykuanNvbih7bWVzc2FnZTogXCJFcnJvciB5b3UgZG9uJ3QgaGF2ZSB0aGUgY29ycmVjdCBwZXJtaXNzaW9uc1wifSlcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9Y2F0Y2goZXJyKXtcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNTAwKS5qc29uKHtlcnJ9KVxuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAYXBpIHtnZXR9IC91c2VyIFJlcXVlc3QgYSBzcGVjaWZpYyB1c2VyIHRoYW5rcyB0byBoaXMgdG9rZW5cbiAgICAgKiBAYXBpTmFtZSBnZXRCeUlkXG4gICAgICogQGFwaUdyb3VwIFVzZXJcbiAgICAgKiBAYXBpUGFyYW0ge0ludGVnZXJ9IHVzZXJfaWQgb2YgdGhlIHVzZXJcbiAgICAgKiBAYXBpU3VjY2VzcyB7T2JqZWN0fSB1c2VyIG9iamVjdC5cbiAgICAgKiBAYXBpRXJyb3IgKDUwMCkgRXJyb3IgRXJyb3IgdG8gcmVxdWVzdCBkYXRhYmFzZS5cbiAgICAgKiBAYXBpRXJyb3IgKDQwMykgRXJyb3IgRXJyb3Igd3JvbmcgdXNlciBJRC5cbiAgICAgKi9cbiAgICBwdWJsaWMgYXN5bmMgZ2V0QnlJZCAoe3BhcmFtcyxyZXNwb25zZSwgcmVxdWVzdH06SHR0cENvbnRleHRDb250cmFjdCl7XG4gICAgICAgIHRyeXtcbiAgICAgICAgICAgIGlmIChqd3QudmVyaWZ5KHJlcXVlc3QuaW5wdXQoJ2p3dCcpLCAnVE9LRU5fUFJJVkFURV9LRVknKVsndXNlcl9pZCddID09IHBhcmFtcy5pZCl7XG4gICAgICAgICAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZE9yRmFpbChwYXJhbXMuaWQpO1xuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoMjAwKS5qc29uKHt1c2VyfSlcbiAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNDAzKS5qc29uKHttZXNzYWdlOiBcIkVycm9yIHdyb25nIHVzZXIgSURcIn0pXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfWNhdGNoKGVycil7XG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDUwMCkuanNvbih7ZXJyfSlcbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQGFwaSB7cG9zdH0gL3VzZXIvY2xpZW50IGNyZWF0ZSBhIHVzZXIgd2l0aCB0aGUgY2xpZW50IHJvbGVcbiAgICAgKiBAYXBpTmFtZSBjcmVhdGVDbGllbnRcbiAgICAgKiBAYXBpR3JvdXAgVXNlclxuICAgICAqIEBhcGlTdWNjZXNzIHtPYmplY3R9IHVzZXIgb2JqZWN0LlxuICAgICAqIEBhcGlFcnJvciAoNTAwKSBFcnJvciBFcnJvciB0byByZXF1ZXN0IGRhdGFiYXNlLlxuICAgICAqL1xuICAgIHB1YmxpYyBhc3luYyBjcmVhdGVDbGllbnQoeyByZXF1ZXN0ICwgcmVzcG9uc2UgfTpIdHRwQ29udGV4dENvbnRyYWN0KXtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuY3JlYXRlKHt1c2VyX2ZpcnN0bmFtZTpyZXF1ZXN0LmJvZHkoKVsndXNlcl9maXJzdG5hbWUnXSx1c2VyX2xhc3RuYW1lOnJlcXVlc3QuYm9keSgpWyd1c2VyX2xhc3RuYW1lJ10sdXNlcl9lbWFpbDpyZXF1ZXN0LmJvZHkoKVsndXNlcl9lbWFpbCddLHVzZXJfcGFzc3dvcmQ6cmVxdWVzdC5ib2R5KClbJ3VzZXJfcGFzc3dvcmQnXSx1c2VyX3Bob25lX251bWJlcjpyZXF1ZXN0LmJvZHkoKVsndXNlcl9waG9uZV9udW1iZXInXSwgdXNlcl9pc19zdXBwb3J0ZWQ6cmVxdWVzdC5ib2R5KClbJ3VzZXJfaXNfc3VwcG9ydGVkJ10sdXNlcl9zdXBwb3J0OnJlcXVlc3QuYm9keSgpWyd1c2VyX3N1cHBvcnQnXSx1c2VyX2lzX2RlbGl2ZXJ5OmZhbHNlfSk7XG5cbiAgICAgICAgICAgIGlmIChyZXF1ZXN0LmJvZHkoKVsnZGVsaXZlcnlfYWRkcmVzc19jaXR5J10hPSB1bmRlZmluZWQgJiYgcmVxdWVzdC5ib2R5KClbJ2RlbGl2ZXJ5X2FkZHJlc3Nfc3RyZWV0J10hPSB1bmRlZmluZWQgJiYgcmVxdWVzdC5ib2R5KClbJ2RlbGl2ZXJ5X2FkZHJlc3NfcG9zdGFsX2NvZGUnXSE9IHVuZGVmaW5lZCAmJiByZXF1ZXN0LmJvZHkoKVsnZGVsaXZlcnlfYWRkcmVzc19zdHJlZXRfbnVtYmVyJ10hPSB1bmRlZmluZWQpe1xuICAgICAgICAgICAgICAgIGNvbnN0IGRlbGl2ZXJ5X2FkZHJlc3MgPSBhd2FpdCBBZGRyZXNzLmNyZWF0ZSh7YWRkcmVzc19jaXR5OiByZXF1ZXN0LmJvZHkoKVsnZGVsaXZlcnlfYWRkcmVzc19jaXR5J10sIGFkZHJlc3Nfc3RyZWV0OiByZXF1ZXN0LmJvZHkoKVsnZGVsaXZlcnlfYWRkcmVzc19zdHJlZXQnXSwgYWRkcmVzc19zdHJlZXRfbnVtYmVyOiByZXF1ZXN0LmJvZHkoKVsnZGVsaXZlcnlfYWRkcmVzc19zdHJlZXRfbnVtYmVyJ10sIGFkZHJlc3NfcG9zdGFsX2NvZGU6cmVxdWVzdC5ib2R5KClbJ2RlbGl2ZXJ5X2FkZHJlc3NfcG9zdGFsX2NvZGUnXSB9KTtcbiAgICAgICAgICAgICAgICBhd2FpdCB1c2VyLnJlbGF0ZWQoJ2RlbGl2ZXJ5X2FkZHJlc3NfaWQnKS5hc3NvY2lhdGUoZGVsaXZlcnlfYWRkcmVzcylcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChyZXF1ZXN0LmJvZHkoKVsncGF5bWVudF9hZGRyZXNzX2NpdHknXSE9IHVuZGVmaW5lZCAmJiByZXF1ZXN0LmJvZHkoKVsncGF5bWVudF9hZGRyZXNzX3N0cmVldCddIT0gdW5kZWZpbmVkICYmIHJlcXVlc3QuYm9keSgpWydwYXltZW50X2FkZHJlc3NfcG9zdGFsX2NvZGUnXSE9IHVuZGVmaW5lZCAmJiByZXF1ZXN0LmJvZHkoKVsncGF5bWVudF9hZGRyZXNzX3N0cmVldF9udW1iZXInXSE9IHVuZGVmaW5lZCl7XG4gICAgICAgICAgICAgICAgY29uc3QgcGF5bWVudF9hZGRyZXNzID0gYXdhaXQgQWRkcmVzcy5jcmVhdGUoe2FkZHJlc3NfY2l0eTogcmVxdWVzdC5ib2R5KClbJ3BheW1lbnRfYWRkcmVzc19jaXR5J10sIGFkZHJlc3Nfc3RyZWV0OiByZXF1ZXN0LmJvZHkoKVsncGF5bWVudF9hZGRyZXNzX3N0cmVldCddLCBhZGRyZXNzX3N0cmVldF9udW1iZXI6IHJlcXVlc3QuYm9keSgpWydwYXltZW50X2FkZHJlc3Nfc3RyZWV0X251bWJlciddLCBhZGRyZXNzX3Bvc3RhbF9jb2RlOnJlcXVlc3QuYm9keSgpWydwYXltZW50X2FkZHJlc3NfcG9zdGFsX2NvZGUnXSB9KTtcbiAgICAgICAgICAgICAgICBhd2FpdCB1c2VyLnJlbGF0ZWQoJ3BheW1lbnRfYWRkcmVzc19pZCcpLmFzc29jaWF0ZShwYXltZW50X2FkZHJlc3MpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocmVxdWVzdC5ib2R5KClbJ2NyZWRpdF9jYXJkX3R5cGUnXSE9dW5kZWZpbmVkICYmIHJlcXVlc3QuYm9keSgpWydjcmVkaXRfY2FyZF9udW0nXSE9dW5kZWZpbmVkICl7XG4gICAgICAgICAgICAgICAgY29uc3QgY3JlZGl0Y2FyZCA9IGF3YWl0IENyZWRpdENhcmQuY3JlYXRlKHtjcmVkaXRfY2FyZF90eXBlOiByZXF1ZXN0LmJvZHkoKVsnY3JlZGl0X2NhcmRfdHlwZSddLCBjcmVkaXRfY2FyZF9udW0gOiByZXF1ZXN0LmJvZHkoKVsnY3JlZGl0X2NhcmRfbnVtJ10gfSk7XG4gICAgICAgICAgICAgICAgYXdhaXQgdXNlci5yZWxhdGVkKCdjcmVkaXRfY2FyZCcpLmFzc29jaWF0ZShjcmVkaXRjYXJkKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3Qgcm9sZSA9IGF3YWl0IFJvbGUuZmluZE9yRmFpbCgxKVxuICAgICAgICAgICAgYXdhaXQgdXNlci5yZWxhdGVkKCdyb2xlJykuYXNzb2NpYXRlKHJvbGUpXG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDIwMSkuanNvbih7dXNlcn0pXG4gICAgICAgIH1jYXRjaChlcnIpe1xuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg1MDApLmpzb24oe2Vycn0pXG4gICAgICAgIH1cblxuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQGFwaSB7cG9zdH0gL3VzZXIvZGVsaXZlcnkgY3JlYXRlIGEgdXNlciB3aXRoIHRoZSBkZWxpdmVyeSBtYW4gcm9sZVxuICAgICAqIEBhcGlOYW1lIGNyZWF0ZURlbGl2ZXJ5XG4gICAgICogQGFwaUdyb3VwIFVzZXJcbiAgICAgKiBAYXBpU3VjY2VzcyB7T2JqZWN0fSB1c2VyIG9iamVjdC5cbiAgICAgKiBAYXBpRXJyb3IgKDUwMCkgRXJyb3IgRXJyb3IgdG8gcmVxdWVzdCBkYXRhYmFzZS5cbiAgICAgKi9cbiAgICBwdWJsaWMgYXN5bmMgY3JlYXRlRGVsaXZlcnkoeyByZXF1ZXN0ICwgcmVzcG9uc2UgfTpIdHRwQ29udGV4dENvbnRyYWN0KXtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyLmNyZWF0ZSh7dXNlcl9maXJzdG5hbWU6cmVxdWVzdC5ib2R5KClbJ3VzZXJfZmlyc3RuYW1lJ10sdXNlcl9sYXN0bmFtZTpyZXF1ZXN0LmJvZHkoKVsndXNlcl9sYXN0bmFtZSddLHVzZXJfZW1haWw6cmVxdWVzdC5ib2R5KClbJ3VzZXJfZW1haWwnXSx1c2VyX3Bhc3N3b3JkOnJlcXVlc3QuYm9keSgpWyd1c2VyX3Bhc3N3b3JkJ10sdXNlcl9waG9uZV9udW1iZXI6cmVxdWVzdC5ib2R5KClbJ3VzZXJfcGhvbmVfbnVtYmVyJ10sIHVzZXJfaXNfc3VwcG9ydGVkOnJlcXVlc3QuYm9keSgpWyd1c2VyX2lzX3N1cHBvcnRlZCddLHVzZXJfc3VwcG9ydDpyZXF1ZXN0LmJvZHkoKVsndXNlcl9zdXBwb3J0J10sdXNlcl9pc19kZWxpdmVyeTp0cnVlfSk7XG4gICAgICAgICAgICBjb25zdCByb2xlID0gYXdhaXQgUm9sZS5maW5kT3JGYWlsKDIpXG4gICAgICAgICAgICBhd2FpdCB1c2VyLnJlbGF0ZWQoJ3JvbGUnKS5hc3NvY2lhdGUocm9sZSlcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoMjAxKS5qc29uKHt1c2VyfSlcblxuICAgICAgICB9Y2F0Y2goZXJyKXtcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNTAwKS5qc29uKHtlcnJ9KVxuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAYXBpIHtwb3N0fSAvdXNlci9kZWxpdmVyeSBjcmVhdGUgYSB1c2VyIHdpdGggdGhlIHJlc3RvcmVyIHJvbGVcbiAgICAgKiBAYXBpTmFtZSBjcmVhdGVSZXN0b3JlclxuICAgICAqIEBhcGlHcm91cCBVc2VyXG4gICAgICogQGFwaVN1Y2Nlc3Mge09iamVjdH0gdXNlciBvYmplY3QuXG4gICAgICogQGFwaUVycm9yICg1MDApIEVycm9yIEVycm9yIHRvIHJlcXVlc3QgZGF0YWJhc2UuXG4gICAgICovXG4gICAgcHVibGljIGFzeW5jIGNyZWF0ZVJlc3RvcmVyKHsgcmVxdWVzdCAsIHJlc3BvbnNlIH06SHR0cENvbnRleHRDb250cmFjdCl7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCB1c2VyID0gYXdhaXQgVXNlci5jcmVhdGUoe3VzZXJfZmlyc3RuYW1lOnJlcXVlc3QuYm9keSgpWyd1c2VyX2ZpcnN0bmFtZSddLHVzZXJfbGFzdG5hbWU6cmVxdWVzdC5ib2R5KClbJ3VzZXJfbGFzdG5hbWUnXSx1c2VyX2VtYWlsOnJlcXVlc3QuYm9keSgpWyd1c2VyX2VtYWlsJ10sdXNlcl9wYXNzd29yZDpyZXF1ZXN0LmJvZHkoKVsndXNlcl9wYXNzd29yZCddLHVzZXJfcGhvbmVfbnVtYmVyOnJlcXVlc3QuYm9keSgpWyd1c2VyX3Bob25lX251bWJlciddLCB1c2VyX2lzX3N1cHBvcnRlZDpmYWxzZSx1c2VyX3N1cHBvcnQ6ZmFsc2UsdXNlcl9pc19kZWxpdmVyeTpmYWxzZX0pO1xuICAgICAgICAgICAgY29uc3Qgcm9sZSA9IGF3YWl0IFJvbGUuZmluZE9yRmFpbCgzKVxuICAgICAgICAgICAgYXdhaXQgdXNlci5yZWxhdGVkKCdyb2xlJykuYXNzb2NpYXRlKHJvbGUpXG4gICAgICAgICAgICBjb25zdCByZXN0b3JlciA9IGF3YWl0IFJlc3RvcmVyLmNyZWF0ZSh7cmVzdG9yZXJfbmFtZSA6IHJlcXVlc3QuYm9keSgpWydyZXN0b3Jlcl9uYW1lJ119KVxuICAgICAgICAgICAgY29uc3QgYWRkcmVzcyA9IGF3YWl0IEFkZHJlc3MuY3JlYXRlKHthZGRyZXNzX2NpdHk6IHJlcXVlc3QuYm9keSgpWydyZXN0b3Jlcl9hZGRyZXNzX2NpdHknXSwgYWRkcmVzc19zdHJlZXQ6IHJlcXVlc3QuYm9keSgpWydyZXN0b3Jlcl9hZGRyZXNzX3N0cmVldCddLCBhZGRyZXNzX3N0cmVldF9udW1iZXI6IHJlcXVlc3QuYm9keSgpWydyZXN0b3Jlcl9hZGRyZXNzX3N0cmVldF9udW1iZXInXSwgYWRkcmVzc19wb3N0YWxfY29kZTpyZXF1ZXN0LmJvZHkoKVsncmVzdG9yZXJfYWRkcmVzc19wb3N0YWxfY29kZSddIH0pXG4gICAgICAgICAgICBhd2FpdCByZXN0b3Jlci5yZWxhdGVkKCdhZGRyZXNzJykuYXNzb2NpYXRlKGFkZHJlc3MpXG4gICAgICAgICAgICBhd2FpdCB1c2VyLnJlbGF0ZWQoJ3Jlc3RvcmVyJykuYXNzb2NpYXRlKHJlc3RvcmVyKVxuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cygyMDEpLmpzb24oe3VzZXJ9KVxuXG4gICAgICAgIH1jYXRjaChlcnIpe1xuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg1MDApLmpzb24oe2Vycn0pXG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBhcGkge3B1dH0gL3VzZXIvOmlkIHVwZGF0ZSB0aGUgc3BlY2lmaWVkIHVzZXJcbiAgICAgKiBAYXBpTmFtZSB1cGRhdGVcbiAgICAgKiBAYXBpR3JvdXAgVXNlclxuICAgICAqIEBhcGlQYXJhbSB7SW50ZWdlcn0gdXNlcl9pZCBJZCBvZiB0aGUgdXNlci5cbiAgICAgKiBAYXBpU3VjY2VzcyB7T2JqZWN0fSB1c2VyIG9iamVjdC5cbiAgICAgKiBAYXBpRXJyb3IgKDUwMCkgRXJyb3IgRXJyb3IgdG8gcmVxdWVzdCBkYXRhYmFzZS5cbiAgICAgKiBAYXBpRXJyb3IgKDQwMykgRXJyb3IgV3JvbmcgdXNlciBJRC5cbiAgICAgKi9cbiAgICBwdWJsaWMgYXN5bmMgdXBkYXRlICh7cmVxdWVzdCwgcmVzcG9uc2UsIHBhcmFtc306SHR0cENvbnRleHRDb250cmFjdCl7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpZiAoand0LnZlcmlmeShyZXF1ZXN0LmlucHV0KCdqd3QnKSwgJ1RPS0VOX1BSSVZBVEVfS0VZJylbJ3VzZXJfaWQnXSA9PSBwYXJhbXMuaWQpe1xuICAgICAgICAgICAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyLmZpbmRPckZhaWwocGFyYW1zLmlkKTtcbiAgICAgICAgICAgICAgICB1c2VyLm1lcmdlKHt1c2VyX2ZpcnN0bmFtZTpyZXF1ZXN0LmJvZHkoKVsndXNlcl9maXJzdG5hbWUnXSx1c2VyX2xhc3RuYW1lOnJlcXVlc3QuYm9keSgpWyd1c2VyX2xhc3RuYW1lJ10sdXNlcl9lbWFpbDpyZXF1ZXN0LmJvZHkoKVsndXNlcl9lbWFpbCddLHVzZXJfcGFzc3dvcmQ6cmVxdWVzdC5ib2R5KClbJ3VzZXJfcGFzc3dvcmQnXSx1c2VyX3Bob25lX251bWJlcjpyZXF1ZXN0LmJvZHkoKVsndXNlcl9waG9uZV9udW1iZXInXX0pO1xuICAgICAgICAgICAgICAgIGF3YWl0IHVzZXIuc2F2ZSgpO1xuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoMjAwKS5qc29uKHt1c2VyfSlcbiAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNDAzKS5qc29uKHttZXNzYWdlOiBcIkVycm9yIHdyb25nIHVzZXIgSURcIn0pXG4gICAgICAgICAgICB9XG5cblxuICAgICAgICB9Y2F0Y2goZXJyKXtcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNTAwKS5qc29uKHtlcnJ9KVxuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAYXBpIHtwdXR9IC91c2VyLzppZCB1cGRhdGUgdGhlIHNwZWNpZmllZCB1c2VyIGZvciBzcG9uc29yaW5nXG4gICAgICogQGFwaU5hbWUgdXBkYXRlU3BvbnNvclxuICAgICAqIEBhcGlHcm91cCBVc2VyXG4gICAgICogQGFwaVBhcmFtIHtJbnRlZ2VyfSB1c2VyX2lkIElkIG9mIHRoZSB1c2VyLlxuICAgICAqIEBhcGlTdWNjZXNzIHtPYmplY3R9IHVzZXIgb2JqZWN0LlxuICAgICAqIEBhcGlFcnJvciAoNTAwKSBFcnJvciBFcnJvciB0byByZXF1ZXN0IGRhdGFiYXNlLlxuICAgICAqIEBhcGlFcnJvciAoNDAzKSBFcnJvciBXcm9uZyB1c2VyIElELlxuICAgICAqIEBhcGlFcnJvciAoNDAwKSBlcnJvciB0aGlzIHVzZXIgaXMgYWxyZWFkeSBzdXBwb3J0ZWQgb3IgeW91IGVudGVyIHRoZSB3cm9uZyBlbWFpbFxuICAgICAqIEBhcGlFcnJvciAoNDAwKSBlcnJvciBVbmFibGUgdG8gZmluZCB0aGUgdXNlciBvciB0aGUgdXNlciBpcyBhbHJlYWR5IHN1cHBvcnRpbmcgc29tZW9uZVxuICAgICAqL1xuICAgICBwdWJsaWMgYXN5bmMgdXBkYXRlU3BvbnNvciAoe3JlcXVlc3QsIHJlc3BvbnNlLCBwYXJhbXN9Okh0dHBDb250ZXh0Q29udHJhY3Qpe1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgaWYgKGp3dC52ZXJpZnkocmVxdWVzdC5pbnB1dCgnand0JyksICdUT0tFTl9QUklWQVRFX0tFWScpWyd1c2VyX2lkJ10gPT0gcGFyYW1zLmlkKXtcbiAgICAgICAgICAgICAgICBjb25zdCB1c2VyID0gYXdhaXQgVXNlci5maW5kT3JGYWlsKHBhcmFtcy5pZCk7XG4gICAgICAgICAgICAgICAgY29uc3QgZmlsbGV1bCA9IGF3YWl0IFVzZXIuZmluZEJ5KCd1c2VyX2VtYWlsJywgcmVxdWVzdC5ib2R5KClbJ2ZpbGxldWxfZW1haWwnXSlcbiAgICAgICAgICAgICAgICBpZiAodXNlci51c2VyX3N1cHBvcnQ9PWZhbHNlICYmIGZpbGxldWwgJiYgdXNlci5ma19yb2xlX2lkID09IGZpbGxldWwuZmtfcm9sZV9pZCl7XG4gICAgICAgICAgICAgICAgICAgIGlmIChmaWxsZXVsLnVzZXJfaXNfc3VwcG9ydGVkID09IGZhbHNlKXtcbiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXIudXNlcl9zdXBwb3J0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHVzZXIuc2F2ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZmlsbGV1bC51c2VyX2lzX3N1cHBvcnRlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBmaWxsZXVsLnNhdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDQwMCkuanNvbih7bWVzc2FnZTogXCJlcnJvciB0aGlzIHVzZXIgaXMgYWxyZWFkeSBzdXBwb3J0ZWQgb3IgeW91IGVudGVyIHRoZSB3cm9uZyBlbWFpbFwifSlcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDIwMCkuanNvbih7dXNlcn0pXG4gICAgICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNDAwKS5qc29uKHttZXNzYWdlOiBcImVycm9yIFVuYWJsZSB0byBmaW5kIHRoZSB1c2VyIG9yIHRoZSB1c2VyIGlzIGFscmVhZHkgc3VwcG9ydGluZyBzb21lb25lXCJ9KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNDAzKS5qc29uKHttZXNzYWdlOiBcIkVycm9yIHdyb25nIHVzZXIgSURcIn0pXG4gICAgICAgICAgICB9XG4gICAgICAgIH1jYXRjaChlcnIpe1xuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg1MDApLmpzb24oe2Vycn0pXG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBhcGkge2RlbGV0ZX0gL3VzZXIvOmlkIGRlbGV0ZSB0aGUgc3BlY2lmaWVkIHVzZXJcbiAgICAgKiBAYXBpTmFtZSBkZWxldGVcbiAgICAgKiBAYXBpR3JvdXAgVXNlclxuICAgICAqIEBhcGlQYXJhbSB7SW50ZWdlcn0gdXNlcl9pZCAgb2YgdGhlIHVzZXIuXG4gICAgICogQGFwaVN1Y2Nlc3Mge09iamVjdH0gdXNlciBvYmplY3QuXG4gICAgICogQGFwaUVycm9yICg1MDApIEVycm9yIEVycm9yIHRvIHJlcXVlc3QgZGF0YWJhc2UuXG4gICAgICogQGFwaUVycm9yICg0MDMpIFdyb25nIHVzZXIgSUQuXG4gICAgICovXG4gICAgcHVibGljIGFzeW5jIGRlbGV0ZSh7cmVzcG9uc2UscmVxdWVzdCwgcGFyYW1zfTpIdHRwQ29udGV4dENvbnRyYWN0KXtcbiAgICAgICAgdHJ5e1xuICAgICAgICAgICAgaWYgKGp3dC52ZXJpZnkocmVxdWVzdC5pbnB1dCgnand0JyksICdUT0tFTl9QUklWQVRFX0tFWScpWyd1c2VyX2lkJ10gPT0gcGFyYW1zLmlkKXtcbiAgICAgICAgICAgICAgICBjb25zdCB1c2VyID0gYXdhaXQgVXNlci5maW5kT3JGYWlsKHBhcmFtcy5pZCk7XG4gICAgICAgICAgICAgICAgYXdhaXQgdXNlci5kZWxldGUoKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDIwMCkuanNvbih7dXNlcn0pXG4gICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDQwMykuanNvbih7bWVzc2FnZTogXCJFcnJvciB3cm9uZyB1c2VyIElEXCJ9KVxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH1jYXRjaChlcnIpe1xuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg1MDApLmpzb24oe2Vycn0pXG4gICAgICAgIH1cblxuICAgIH1cblxufVxuIl19