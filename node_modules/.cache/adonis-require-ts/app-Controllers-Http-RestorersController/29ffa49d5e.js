"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const User_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/User"));
const Restorer_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/Restorer"));
const Address_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/Address"));
const jsonwebtoken_1 = __importDefault(require("jsonwebtoken"));
class RestorersController {
    async index({ response, request }) {
        const restorers = await Restorer_1.default.query();
        return response.status(200).json({ restorers });
    }
    async getById({ params, request, response }) {
        try {
            const user = await User_1.default.findOrFail(jsonwebtoken_1.default.verify(request.input('jwt'), 'TOKEN_PRIVATE_KEY')['user_id']);
            if (user.fk_role_id != null) {
                const restorer = await Restorer_1.default.findOrFail(user.fk_restorer_id);
                return response.status(200).json({ restorer });
            }
            else if (user.fk_restorer_id == null) {
                return response.status(200).json({ message: 'This user does not have  a restorer create it instead' });
            }
            else {
                return response.status(403).json({ message: 'error wrong user id' });
            }
        }
        catch (err) {
            return response.status(500).json({ err });
        }
    }
    async create({ request, response }) {
        try {
            const user = await User_1.default.findOrFail(jsonwebtoken_1.default.verify(request.input('jwt'), 'TOKEN_PRIVATE_KEY')['user_id']);
            if (user.fk_restorer_id == null) {
                const restorer = await Restorer_1.default.create({ restorer_name: request.body()['restorer_name'] });
                const address = await Address_1.default.create({ address_city: request.body()['address_city'], address_street: request.body()['address_street'], address_street_number: request.body()['address_street_number'], address_postal_code: request.body()['address_postal_code'] });
                await restorer.related('address').associate(address);
                await user.related('restorer').associate(restorer);
                return response.status(200).json({ restorer });
            }
            else if (user.fk_restorer_id != null) {
                return response.status(400).json({ message: 'Error this user has already a restorer update it instead' });
            }
            else {
                return response.status(403).json({ message: 'error wrong user id' });
            }
        }
        catch (err) {
            return response.status(500).json({ err });
        }
    }
    async update({ request, response, params }) {
        try {
            const user = await User_1.default.findOrFail(jsonwebtoken_1.default.verify(request.input('jwt'), 'TOKEN_PRIVATE_KEY')['user_id']);
            if (user.fk_restorer_id != null) {
                const restorer = await Restorer_1.default.findOrFail(user.fk_restorer_id);
                restorer.merge(request.body());
                await restorer.save();
                return response.status(200).json({ restorer });
            }
            else if (user.fk_restorer_id == null) {
                return response.status(400).json({ message: 'Error this user does not have  a restorer create it instead' });
            }
            else {
                return response.status(403).json({ message: 'error wrong user id' });
            }
        }
        catch (err) {
            return response.status(500).json({ err });
        }
    }
    async delete({ response, request, params }) {
        try {
            const user = await User_1.default.findOrFail(jsonwebtoken_1.default.verify(request.input('jwt'), 'TOKEN_PRIVATE_KEY')['user_id']);
            if (user.fk_restorer_id != null) {
                const restorer = await Restorer_1.default.findOrFail(user.fk_restorer_id);
                await restorer.delete();
                return response.status(200).json({ restorer });
            }
            else if (user.fk_restorer_id == null) {
                return response.status(400).json({ message: 'Error this user does not have a restorer yet ' });
            }
            else {
                return response.status(500).json({ message: 'error wrong user id' });
            }
        }
        catch (err) {
            return response.status(500).json({ err });
        }
    }
}
exports.default = RestorersController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVzdG9yZXJzQ29udHJvbGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIlJlc3RvcmVyc0NvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFDQSxpRkFBbUM7QUFDbkMseUZBQTJDO0FBQzNDLHVGQUF5QztBQUN6QyxnRUFBOEI7QUFHOUIsTUFBcUIsbUJBQW1CO0lBQzdCLEtBQUssQ0FBQyxLQUFLLENBQUUsRUFBQyxRQUFRLEVBQUMsT0FBTyxFQUFxQjtRQUk5QyxNQUFNLFNBQVMsR0FBRyxNQUFNLGtCQUFRLENBQUMsS0FBSyxFQUFFLENBQUE7UUFDeEMsT0FBTyxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFDLFNBQVMsRUFBQyxDQUFDLENBQUE7SUFTekQsQ0FBQztJQUVNLEtBQUssQ0FBQyxPQUFPLENBQUUsRUFBQyxNQUFNLEVBQUMsT0FBTyxFQUFDLFFBQVEsRUFBcUI7UUFDL0QsSUFBRztZQUNDLE1BQU0sSUFBSSxHQUFHLE1BQU0sY0FBSSxDQUFDLFVBQVUsQ0FBQyxzQkFBRyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFFLG1CQUFtQixDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQTtZQUNwRyxJQUFJLElBQUksQ0FBQyxVQUFVLElBQUUsSUFBSSxFQUFDO2dCQUN0QixNQUFNLFFBQVEsR0FBRyxNQUFNLGtCQUFRLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztnQkFDaEUsT0FBTyxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFDLFFBQVEsRUFBQyxDQUFDLENBQUE7YUFDL0M7aUJBQUssSUFBRyxJQUFJLENBQUMsY0FBYyxJQUFFLElBQUksRUFBQztnQkFDL0IsT0FBTyxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FB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LE1BQU0sUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDO2dCQUN4QixPQUFPLFFBQVEsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUMsUUFBUSxFQUFDLENBQUMsQ0FBQTthQUMvQztpQkFBSyxJQUFHLElBQUksQ0FBQyxjQUFjLElBQUUsSUFBSSxFQUFDO2dCQUMvQixPQUFPLFFBQVEsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUMsT0FBTyxFQUFHLCtDQUErQyxFQUFDLENBQUMsQ0FBQTthQUNoRztpQkFBSTtnQkFDRCxPQUFPLFFBQVEsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUMsT0FBTyxFQUFDLHFCQUFxQixFQUFDLENBQUMsQ0FBQTthQUNwRTtTQUVKO1FBQUEsT0FBTSxHQUFHLEVBQUM7WUFDUCxPQUFPLFFBQVEsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUMsR0FBRyxFQUFDLENBQUMsQ0FBQTtTQUMxQztJQUVMLENBQUM7Q0FDSjtBQTlGRCxzQ0E4RkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIdHRwQ29udGV4dENvbnRyYWN0IH0gZnJvbSAnQGlvYzpBZG9uaXMvQ29yZS9IdHRwQ29udGV4dCdcclxuaW1wb3J0IFVzZXIgZnJvbSAnQXBwL01vZGVscy9Vc2VyJztcclxuaW1wb3J0IFJlc3RvcmVyIGZyb20gJ0FwcC9Nb2RlbHMvUmVzdG9yZXInO1xyXG5pbXBvcnQgQWRkcmVzcyBmcm9tICdBcHAvTW9kZWxzL0FkZHJlc3MnO1xyXG5pbXBvcnQgand0IGZyb20gJ2pzb253ZWJ0b2tlbidcclxuXHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBSZXN0b3JlcnNDb250cm9sbGVyIHtcclxuICAgIHB1YmxpYyBhc3luYyBpbmRleCAoe3Jlc3BvbnNlLHJlcXVlc3R9Okh0dHBDb250ZXh0Q29udHJhY3Qpe1xyXG4gICAgICAgIC8vdHJ5e1xyXG4gICAgICAgICAgICAvL2NvbnN0IHVzZXIgPSBhd2FpdCBVc2VyLmZpbmRPckZhaWwoand0LnZlcmlmeShyZXF1ZXN0LmlucHV0KCdqd3QnKSwgJ1RPS0VOX1BSSVZBVEVfS0VZJylbJ3VzZXJfaWQnXSlcclxuICAgICAgICAgICAgLy9pZiAodXNlci5yb2xlLnJvbGVfaWQgPT0gNSB8fCB1c2VyLnJvbGUucm9sZV9pZCA9PSA0KXtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3RvcmVycyA9IGF3YWl0IFJlc3RvcmVyLnF1ZXJ5KClcclxuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoMjAwKS5qc29uKHtyZXN0b3JlcnN9KVxyXG4gICAgICAgICAgICAvKn1lbHNle1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg0MDMpLmpzb24oe21lc3NhZ2U6J2Vycm9yIHdyb25nIHVzZXIgcGVybWlzc2lvbid9KVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH1jYXRjaChlcnIpe1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDUwMCkuanNvbih7ZXJyfSlcclxuICAgICAgICB9Ki9cclxuXHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGFzeW5jIGdldEJ5SWQgKHtwYXJhbXMscmVxdWVzdCxyZXNwb25zZX06SHR0cENvbnRleHRDb250cmFjdCl7XHJcbiAgICAgICAgdHJ5e1xyXG4gICAgICAgICAgICBjb25zdCB1c2VyID0gYXdhaXQgVXNlci5maW5kT3JGYWlsKGp3dC52ZXJpZnkocmVxdWVzdC5pbnB1dCgnand0JyksICdUT0tFTl9QUklWQVRFX0tFWScpWyd1c2VyX2lkJ10pXHJcbiAgICAgICAgICAgIGlmICh1c2VyLmZrX3JvbGVfaWQhPW51bGwpe1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVzdG9yZXIgPSBhd2FpdCBSZXN0b3Jlci5maW5kT3JGYWlsKHVzZXIuZmtfcmVzdG9yZXJfaWQpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cygyMDApLmpzb24oe3Jlc3RvcmVyfSlcclxuICAgICAgICAgICAgfWVsc2UgaWYodXNlci5ma19yZXN0b3Jlcl9pZD09bnVsbCl7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDIwMCkuanNvbih7bWVzc2FnZSA6ICdUaGlzIHVzZXIgZG9lcyBub3QgaGF2ZSAgYSByZXN0b3JlciBjcmVhdGUgaXQgaW5zdGVhZCd9KVxyXG4gICAgICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNDAzKS5qc29uKHttZXNzYWdlOidlcnJvciB3cm9uZyB1c2VyIGlkJ30pXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfWNhdGNoKGVycil7XHJcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNTAwKS5qc29uKHtlcnJ9KVxyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGFzeW5jIGNyZWF0ZSh7IHJlcXVlc3QgLCByZXNwb25zZSB9Okh0dHBDb250ZXh0Q29udHJhY3Qpe1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyLmZpbmRPckZhaWwoand0LnZlcmlmeShyZXF1ZXN0LmlucHV0KCdqd3QnKSwgJ1RPS0VOX1BSSVZBVEVfS0VZJylbJ3VzZXJfaWQnXSlcclxuICAgICAgICAgICAgaWYgKHVzZXIuZmtfcmVzdG9yZXJfaWQ9PW51bGwpe1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVzdG9yZXIgPSBhd2FpdCBSZXN0b3Jlci5jcmVhdGUoe3Jlc3RvcmVyX25hbWU6IHJlcXVlc3QuYm9keSgpWydyZXN0b3Jlcl9uYW1lJ119KTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGFkZHJlc3MgPSBhd2FpdCBBZGRyZXNzLmNyZWF0ZSh7YWRkcmVzc19jaXR5OiByZXF1ZXN0LmJvZHkoKVsnYWRkcmVzc19jaXR5J10sIGFkZHJlc3Nfc3RyZWV0OiByZXF1ZXN0LmJvZHkoKVsnYWRkcmVzc19zdHJlZXQnXSwgYWRkcmVzc19zdHJlZXRfbnVtYmVyOiByZXF1ZXN0LmJvZHkoKVsnYWRkcmVzc19zdHJlZXRfbnVtYmVyJ10sIGFkZHJlc3NfcG9zdGFsX2NvZGU6cmVxdWVzdC5ib2R5KClbJ2FkZHJlc3NfcG9zdGFsX2NvZGUnXSB9KVxyXG4gICAgICAgICAgICAgICAgYXdhaXQgcmVzdG9yZXIucmVsYXRlZCgnYWRkcmVzcycpLmFzc29jaWF0ZShhZGRyZXNzKVxyXG4gICAgICAgICAgICAgICAgYXdhaXQgdXNlci5yZWxhdGVkKCdyZXN0b3JlcicpLmFzc29jaWF0ZShyZXN0b3JlcilcclxuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoMjAwKS5qc29uKHtyZXN0b3Jlcn0pXHJcbiAgICAgICAgICAgIH1lbHNlIGlmKHVzZXIuZmtfcmVzdG9yZXJfaWQhPW51bGwpe1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg0MDApLmpzb24oe21lc3NhZ2UgOiAnRXJyb3IgdGhpcyB1c2VyIGhhcyBhbHJlYWR5IGEgcmVzdG9yZXIgdXBkYXRlIGl0IGluc3RlYWQnfSlcclxuICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDQwMykuanNvbih7bWVzc2FnZSA6ICdlcnJvciB3cm9uZyB1c2VyIGlkJ30pXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfWNhdGNoKGVycil7XHJcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNTAwKS5qc29uKHtlcnJ9KVxyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGFzeW5jIHVwZGF0ZSAoe3JlcXVlc3QsIHJlc3BvbnNlLCBwYXJhbXN9Okh0dHBDb250ZXh0Q29udHJhY3Qpe1xyXG4gICAgICAgIHRyeXtcclxuICAgICAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZE9yRmFpbChqd3QudmVyaWZ5KHJlcXVlc3QuaW5wdXQoJ2p3dCcpLCAnVE9LRU5fUFJJVkFURV9LRVknKVsndXNlcl9pZCddKVxyXG4gICAgICAgICAgICBpZiAodXNlci5ma19yZXN0b3Jlcl9pZCE9bnVsbCl7XHJcbiAgICAgICAgICAgICAgICBjb25zdCByZXN0b3JlciA9IGF3YWl0IFJlc3RvcmVyLmZpbmRPckZhaWwodXNlci5ma19yZXN0b3Jlcl9pZCk7XHJcbiAgICAgICAgICAgICAgICByZXN0b3Jlci5tZXJnZShyZXF1ZXN0LmJvZHkoKSk7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCByZXN0b3Jlci5zYXZlKCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDIwMCkuanNvbih7cmVzdG9yZXJ9KVxyXG4gICAgICAgICAgICB9ZWxzZSBpZih1c2VyLmZrX3Jlc3RvcmVyX2lkPT1udWxsKXtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNDAwKS5qc29uKHttZXNzYWdlIDogJ0Vycm9yIHRoaXMgdXNlciBkb2VzIG5vdCBoYXZlICBhIHJlc3RvcmVyIGNyZWF0ZSBpdCBpbnN0ZWFkJ30pXHJcbiAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg0MDMpLmpzb24oe21lc3NhZ2U6J2Vycm9yIHdyb25nIHVzZXIgaWQnfSlcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9Y2F0Y2goZXJyKXtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg1MDApLmpzb24oe2Vycn0pXHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgYXN5bmMgZGVsZXRlKHtyZXNwb25zZSxyZXF1ZXN0LCBwYXJhbXN9Okh0dHBDb250ZXh0Q29udHJhY3Qpe1xyXG4gICAgICAgIHRyeXtcclxuICAgICAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZE9yRmFpbChqd3QudmVyaWZ5KHJlcXVlc3QuaW5wdXQoJ2p3dCcpLCAnVE9LRU5fUFJJVkFURV9LRVknKVsndXNlcl9pZCddKVxyXG4gICAgICAgICAgICBpZiAodXNlci5ma19yZXN0b3Jlcl9pZCE9bnVsbCl7XHJcbiAgICAgICAgICAgICAgICBjb25zdCByZXN0b3JlciA9IGF3YWl0IFJlc3RvcmVyLmZpbmRPckZhaWwodXNlci5ma19yZXN0b3Jlcl9pZCk7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCByZXN0b3Jlci5kZWxldGUoKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoMjAwKS5qc29uKHtyZXN0b3Jlcn0pXHJcbiAgICAgICAgICAgIH1lbHNlIGlmKHVzZXIuZmtfcmVzdG9yZXJfaWQ9PW51bGwpe1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg0MDApLmpzb24oe21lc3NhZ2UgOiAnRXJyb3IgdGhpcyB1c2VyIGRvZXMgbm90IGhhdmUgYSByZXN0b3JlciB5ZXQgJ30pXHJcbiAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg1MDApLmpzb24oe21lc3NhZ2U6J2Vycm9yIHdyb25nIHVzZXIgaWQnfSlcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9Y2F0Y2goZXJyKXtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg1MDApLmpzb24oe2Vycn0pXHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxufVxyXG4iXX0=