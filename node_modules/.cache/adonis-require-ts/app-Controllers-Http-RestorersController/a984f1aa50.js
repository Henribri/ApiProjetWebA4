"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const User_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/User"));
const Restorer_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/Restorer"));
const Address_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/Address"));
const jsonwebtoken_1 = __importDefault(require("jsonwebtoken"));
class RestorersController {
    async index({ response, request }) {
        try {
            const restorers = await Restorer_1.default.query();
            return response.status(200).json({ restorers });
        }
        catch (err) {
            return response.status(500).json({ err });
        }
    }
    async getById({ params, request, response }) {
        try {
            const user = await User_1.default.findOrFail(jsonwebtoken_1.default.verify(request.input('jwt'), 'TOKEN_PRIVATE_KEY')['user_id']);
            if (user.fk_role_id != null) {
                const restorer = await Restorer_1.default.findOrFail(user.fk_restorer_id);
                return response.status(200).json({ restorer });
            }
            else if (user.fk_restorer_id == null) {
                return response.status(200).json({ message: 'This user does not have  a restorer create it instead' });
            }
            else {
                return response.status(403).json({ message: 'error wrong user id' });
            }
        }
        catch (err) {
            return response.status(500).json({ err });
        }
    }
    async create({ request, response }) {
        try {
            const user = await User_1.default.findOrFail(jsonwebtoken_1.default.verify(request.input('jwt'), 'TOKEN_PRIVATE_KEY')['user_id']);
            if (user.fk_restorer_id == null) {
                const restorer = await Restorer_1.default.create({ restorer_name: request.body()['restorer_name'] });
                const address = await Address_1.default.create({ address_city: request.body()['address_city'], address_street: request.body()['address_street'], address_street_number: request.body()['address_street_number'], address_postal_code: request.body()['address_postal_code'] });
                await restorer.related('address').associate(address);
                await user.related('restorer').associate(restorer);
                return response.status(200).json({ restorer });
            }
            else if (user.fk_restorer_id != null) {
                return response.status(400).json({ message: 'Error this user has already a restorer update it instead' });
            }
            else {
                return response.status(403).json({ message: 'error wrong user id' });
            }
        }
        catch (err) {
            return response.status(500).json({ err });
        }
    }
    async update({ request, response, params }) {
        try {
            const user = await User_1.default.findOrFail(jsonwebtoken_1.default.verify(request.input('jwt'), 'TOKEN_PRIVATE_KEY')['user_id']);
            if (user.fk_restorer_id != null) {
                const restorer = await Restorer_1.default.findOrFail(user.fk_restorer_id);
                restorer.merge(request.body());
                await restorer.save();
                return response.status(200).json({ restorer });
            }
            else if (user.fk_restorer_id == null) {
                return response.status(400).json({ message: 'Error this user does not have  a restorer create it instead' });
            }
            else {
                return response.status(403).json({ message: 'error wrong user id' });
            }
        }
        catch (err) {
            return response.status(500).json({ err });
        }
    }
    async delete({ response, request, params }) {
        try {
            const user = await User_1.default.findOrFail(jsonwebtoken_1.default.verify(request.input('jwt'), 'TOKEN_PRIVATE_KEY')['user_id']);
            if (user.fk_restorer_id != null) {
                const restorer = await Restorer_1.default.findOrFail(user.fk_restorer_id);
                await restorer.delete();
                return response.status(200).json({ restorer });
            }
            else if (user.fk_restorer_id == null) {
                return response.status(400).json({ message: 'Error this user does not have a restorer yet ' });
            }
            else {
                return response.status(500).json({ message: 'error wrong user id' });
            }
        }
        catch (err) {
            return response.status(500).json({ err });
        }
    }
}
exports.default = RestorersController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVzdG9yZXJzQ29udHJvbGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIlJlc3RvcmVyc0NvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFDQSxpRkFBbUM7QUFDbkMseUZBQTJDO0FBQzNDLHVGQUF5QztBQUN6QyxnRUFBOEI7QUFHOUIsTUFBcUIsbUJBQW1CO0lBQzdCLEtBQUssQ0FBQyxLQUFLLENBQUUsRUFBQyxRQUFRLEVBQUMsT0FBTyxFQUFxQjtRQUN0RCxJQUFHO1lBQ0MsTUFBTSxTQUFTLEdBQUcsTUFBTSxrQkFBUSxDQUFDLEtBQUssRUFBRSxDQUFBO1lBQ3hDLE9BQU8sUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBQyxTQUFTLEVBQUMsQ0FBQyxDQUFBO1NBRWhEO1FBQUEsT0FBTSxHQUFHLEVBQUM7WUFDUCxPQUFPLFFBQVEsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUMsR0FBRyxFQUFDLENBQUMsQ0FBQTtTQUMxQztJQUVMLENBQUM7SUFFTSxLQUFLLENBQUMsT0FBTyxDQUFFLEVBQUMsTUFBTSxFQUFDLE9BQU8sRUFBQyxRQUFRLEVBQXFCO1FBQy9ELElBQUc7WUFDQyxNQUFNLElBQUksR0FBRyxNQUFNLGNBQUksQ0FBQyxVQUFVLENBQUMsc0JBQUcsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRSxtQkFBbUIsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUE7WUFDcEcsSUFBSSxJQUFJLENBQUMsVUFBVSxJQUFFLElBQUksRUFBQztnQkFDdEIsTUFBTSxRQUFRLEdBQUcsTUFBTSxrQkFBUSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7Z0JBQ2hFLE9BQU8sUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBQyxR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O1lBQ3BHLElBQUksSUFBSSxDQUFDLGNBQWMsSUFBRSxJQUFJLEVBQUM7Z0JBQzFCLE1BQU0sUUFBUSxHQUFHLE1BQU0sa0JBQVEsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO2dCQUNoRSxNQUFNLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQztnQkFDeEIsT0FBTyxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFDLFFBQVEsRUFBQyxDQUFDLENBQUE7YUFDL0M7aUJBQUssSUFBRyxJQUFJLENBQUMsY0FBYyxJQUFFLElBQUksRUFBQztnQkFDL0IsT0FBTyxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFDLE9BQU8sRUFBRywrQ0FBK0MsRUFBQyxDQUFDLENBQUE7YUFDaEc7aUJBQUk7Z0JBQ0QsT0FBTyxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFDLE9BQU8sRUFBQyxxQkFBcUIsRUFBQyxDQUFDLENBQUE7YUFDcEU7U0FFSjtRQUFBLE9BQU0sR0FBRyxFQUFDO1lBQ1AsT0FBTyxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFDLEdBQUcsRUFBQyxDQUFDLENBQUE7U0FDMUM7SUFFTCxDQUFDO0NBQ0o7QUF6RkQsc0NBeUZDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSHR0cENvbnRleHRDb250cmFjdCB9IGZyb20gJ0Bpb2M6QWRvbmlzL0NvcmUvSHR0cENvbnRleHQnXG5pbXBvcnQgVXNlciBmcm9tICdBcHAvTW9kZWxzL1VzZXInO1xuaW1wb3J0IFJlc3RvcmVyIGZyb20gJ0FwcC9Nb2RlbHMvUmVzdG9yZXInO1xuaW1wb3J0IEFkZHJlc3MgZnJvbSAnQXBwL01vZGVscy9BZGRyZXNzJztcbmltcG9ydCBqd3QgZnJvbSAnanNvbndlYnRva2VuJ1xuXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJlc3RvcmVyc0NvbnRyb2xsZXIge1xuICAgIHB1YmxpYyBhc3luYyBpbmRleCAoe3Jlc3BvbnNlLHJlcXVlc3R9Okh0dHBDb250ZXh0Q29udHJhY3Qpe1xuICAgICAgICB0cnl7XG4gICAgICAgICAgICBjb25zdCByZXN0b3JlcnMgPSBhd2FpdCBSZXN0b3Jlci5xdWVyeSgpXG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDIwMCkuanNvbih7cmVzdG9yZXJzfSlcblxuICAgICAgICB9Y2F0Y2goZXJyKXtcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNTAwKS5qc29uKHtlcnJ9KVxuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgZ2V0QnlJZCAoe3BhcmFtcyxyZXF1ZXN0LHJlc3BvbnNlfTpIdHRwQ29udGV4dENvbnRyYWN0KXtcbiAgICAgICAgdHJ5e1xuICAgICAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZE9yRmFpbChqd3QudmVyaWZ5KHJlcXVlc3QuaW5wdXQoJ2p3dCcpLCAnVE9LRU5fUFJJVkFURV9LRVknKVsndXNlcl9pZCddKVxuICAgICAgICAgICAgaWYgKHVzZXIuZmtfcm9sZV9pZCE9bnVsbCl7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVzdG9yZXIgPSBhd2FpdCBSZXN0b3Jlci5maW5kT3JGYWlsKHVzZXIuZmtfcmVzdG9yZXJfaWQpO1xuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoMjAwKS5qc29uKHtyZXN0b3Jlcn0pXG4gICAgICAgICAgICB9ZWxzZSBpZih1c2VyLmZrX3Jlc3RvcmVyX2lkPT1udWxsKXtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDIwMCkuanNvbih7bWVzc2FnZSA6ICdUaGlzIHVzZXIgZG9lcyBub3QgaGF2ZSAgYSByZXN0b3JlciBjcmVhdGUgaXQgaW5zdGVhZCd9KVxuICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg0MDMpLmpzb24oe21lc3NhZ2U6J2Vycm9yIHdyb25nIHVzZXIgaWQnfSlcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9Y2F0Y2goZXJyKXtcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNTAwKS5qc29uKHtlcnJ9KVxuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgY3JlYXRlKHsgcmVxdWVzdCAsIHJlc3BvbnNlIH06SHR0cENvbnRleHRDb250cmFjdCl7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCB1c2VyID0gYXdhaXQgVXNlci5maW5kT3JGYWlsKGp3dC52ZXJpZnkocmVxdWVzdC5pbnB1dCgnand0JyksICdUT0tFTl9QUklWQVRFX0tFWScpWyd1c2VyX2lkJ10pXG4gICAgICAgICAgICBpZiAodXNlci5ma19yZXN0b3Jlcl9pZD09bnVsbCl7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVzdG9yZXIgPSBhd2FpdCBSZXN0b3Jlci5jcmVhdGUoe3Jlc3RvcmVyX25hbWU6IHJlcXVlc3QuYm9keSgpWydyZXN0b3Jlcl9uYW1lJ119KTtcbiAgICAgICAgICAgICAgICBjb25zdCBhZGRyZXNzID0gYXdhaXQgQWRkcmVzcy5jcmVhdGUoe2FkZHJlc3NfY2l0eTogcmVxdWVzdC5ib2R5KClbJ2FkZHJlc3NfY2l0eSddLCBhZGRyZXNzX3N0cmVldDogcmVxdWVzdC5ib2R5KClbJ2FkZHJlc3Nfc3RyZWV0J10sIGFkZHJlc3Nfc3RyZWV0X251bWJlcjogcmVxdWVzdC5ib2R5KClbJ2FkZHJlc3Nfc3RyZWV0X251bWJlciddLCBhZGRyZXNzX3Bvc3RhbF9jb2RlOnJlcXVlc3QuYm9keSgpWydhZGRyZXNzX3Bvc3RhbF9jb2RlJ10gfSlcbiAgICAgICAgICAgICAgICBhd2FpdCByZXN0b3Jlci5yZWxhdGVkKCdhZGRyZXNzJykuYXNzb2NpYXRlKGFkZHJlc3MpXG4gICAgICAgICAgICAgICAgYXdhaXQgdXNlci5yZWxhdGVkKCdyZXN0b3JlcicpLmFzc29jaWF0ZShyZXN0b3JlcilcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDIwMCkuanNvbih7cmVzdG9yZXJ9KVxuICAgICAgICAgICAgfWVsc2UgaWYodXNlci5ma19yZXN0b3Jlcl9pZCE9bnVsbCl7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg0MDApLmpzb24oe21lc3NhZ2UgOiAnRXJyb3IgdGhpcyB1c2VyIGhhcyBhbHJlYWR5IGEgcmVzdG9yZXIgdXBkYXRlIGl0IGluc3RlYWQnfSlcbiAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNDAzKS5qc29uKHttZXNzYWdlIDogJ2Vycm9yIHdyb25nIHVzZXIgaWQnfSlcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9Y2F0Y2goZXJyKXtcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNTAwKS5qc29uKHtlcnJ9KVxuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgdXBkYXRlICh7cmVxdWVzdCwgcmVzcG9uc2UsIHBhcmFtc306SHR0cENvbnRleHRDb250cmFjdCl7XG4gICAgICAgIHRyeXtcbiAgICAgICAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyLmZpbmRPckZhaWwoand0LnZlcmlmeShyZXF1ZXN0LmlucHV0KCdqd3QnKSwgJ1RPS0VOX1BSSVZBVEVfS0VZJylbJ3VzZXJfaWQnXSlcbiAgICAgICAgICAgIGlmICh1c2VyLmZrX3Jlc3RvcmVyX2lkIT1udWxsKXtcbiAgICAgICAgICAgICAgICBjb25zdCByZXN0b3JlciA9IGF3YWl0IFJlc3RvcmVyLmZpbmRPckZhaWwodXNlci5ma19yZXN0b3Jlcl9pZCk7XG4gICAgICAgICAgICAgICAgcmVzdG9yZXIubWVyZ2UocmVxdWVzdC5ib2R5KCkpO1xuICAgICAgICAgICAgICAgIGF3YWl0IHJlc3RvcmVyLnNhdmUoKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDIwMCkuanNvbih7cmVzdG9yZXJ9KVxuICAgICAgICAgICAgfWVsc2UgaWYodXNlci5ma19yZXN0b3Jlcl9pZD09bnVsbCl7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg0MDApLmpzb24oe21lc3NhZ2UgOiAnRXJyb3IgdGhpcyB1c2VyIGRvZXMgbm90IGhhdmUgIGEgcmVzdG9yZXIgY3JlYXRlIGl0IGluc3RlYWQnfSlcbiAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNDAzKS5qc29uKHttZXNzYWdlOidlcnJvciB3cm9uZyB1c2VyIGlkJ30pXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfWNhdGNoKGVycil7XG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDUwMCkuanNvbih7ZXJyfSlcbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGRlbGV0ZSh7cmVzcG9uc2UscmVxdWVzdCwgcGFyYW1zfTpIdHRwQ29udGV4dENvbnRyYWN0KXtcbiAgICAgICAgdHJ5e1xuICAgICAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZE9yRmFpbChqd3QudmVyaWZ5KHJlcXVlc3QuaW5wdXQoJ2p3dCcpLCAnVE9LRU5fUFJJVkFURV9LRVknKVsndXNlcl9pZCddKVxuICAgICAgICAgICAgaWYgKHVzZXIuZmtfcmVzdG9yZXJfaWQhPW51bGwpe1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3RvcmVyID0gYXdhaXQgUmVzdG9yZXIuZmluZE9yRmFpbCh1c2VyLmZrX3Jlc3RvcmVyX2lkKTtcbiAgICAgICAgICAgICAgICBhd2FpdCByZXN0b3Jlci5kZWxldGUoKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDIwMCkuanNvbih7cmVzdG9yZXJ9KVxuICAgICAgICAgICAgfWVsc2UgaWYodXNlci5ma19yZXN0b3Jlcl9pZD09bnVsbCl7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg0MDApLmpzb24oe21lc3NhZ2UgOiAnRXJyb3IgdGhpcyB1c2VyIGRvZXMgbm90IGhhdmUgYSByZXN0b3JlciB5ZXQgJ30pXG4gICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzKDUwMCkuanNvbih7bWVzc2FnZTonZXJyb3Igd3JvbmcgdXNlciBpZCd9KVxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH1jYXRjaChlcnIpe1xuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg1MDApLmpzb24oe2Vycn0pXG4gICAgICAgIH1cblxuICAgIH1cbn1cbiJdfQ==